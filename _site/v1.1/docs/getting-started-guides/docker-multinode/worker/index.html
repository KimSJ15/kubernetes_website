<!Doctype html>
<html id="docs">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href='https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="/css/styles.css"/>
	<script src="/js/script.js"></script>
    <script src="/js/jquery-2.2.0.min.js"></script>
    <script src="/js/non-mini.js"></script>
    <title>Kubernetes - Adding a Kubernetes worker node via Docker.</title>
</head>
<body>
<div id="cellophane" onclick="kub.toggleMenu()"></div>
<header>
	<a href="/" class="logo"></a>
	<div class="nav-buttons" data-auto-burger="primary">
		<a href="/docs" class="button" id="viewDocs">View Documentation</a>
		<a href="/get-started" class="button" id="tryKubernetes">Try Kubernetes</a>
		<button id="hamburger" onclick="kub.toggleMenu()" data-auto-burger-exclude><div></div></button>
	</div>

	<nav id="mainNav">
		<main data-auto-burger="primary">
			<div class="nav-box">
				<h3><a href="">Get Started</a></h3>
				<p>Built for a multi-cloud world, public, private or hybrid. Seamlessly roll out new features.</p>
			</div>
			<div class="nav-box">
				<h3><a href="">Documentation</a></h3>
				<p>Pellentesque in ipsum id orci porta dapibus. Nulla porttitor accumsan tincidunt. </p>
			</div>
			<div class="nav-box">
				<h3><a href="">Community</a></h3>
				<p>Vestibulum ac diam sit amet quam vehicula elementum sed sit amet dui. </p>
			</div>
			<div class="nav-box">
				<h3><a href="">Blog</a></h3>
				<p>Curabitur arcu erat, accumsan id imperdiet et, porttitor at sem. Quisque velit nisi, pretium ut lacinia in. </p>
			</div>
		</main>
		<main data-auto-burger="primary">
			<div class="left">
				<h5 class="github-invite">Interested in hacking on the core Kubernetes code base?</h5>
				<a href="" class="button">View On Github</a>
			</div>

			<div class="right">
				<h5 class="github-invite">Explore the community</h5>
				<div class="social">
					<a href="https://twitter.com/kubernetesio" class="Twitter"><span>twitter</span></a>
					<a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
					<a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
					<a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>stackoverflow</span></a>
					<a href="https://groups.google.com/forum/#!forum/google-containers" class="mailing-list"><span>Mailing List</span></a>
				</div>
			</div>
			<div class="clear" style="clear: both"></div>
		</main>
	</nav>
</header>

<!--  HERO  -->
<section id="hero" class="light-text">
	<h1></h1>
	<h5></h5>
	<div id="vendorStrip" class="light-text">
		<ul>
			<li><a href="/v1.1/guides">GUIDES</a></li>
			<li><a href="/v1.1/reference">REFERENCE</a></li>
			<li><a href="/v1.1/samples">SAMPLES</a></li>
			<li><a href="/v1.1/support">SUPPORT</a></li>
		</ul>
		<div class="dropdown">
			<div class="readout"></div>
			<a href="/v1.1">Version 1.1</a>
			<a href="/v1.0">Version 1.0</a>
		</div>
		<input type="text" id="search" placeholder="Search the docs">
	</div>
</section>

<section id="encyclopedia">
	<div id="docsToc">
        <div class="pi-accordion">
            
            

        </div> <!-- /pi-accordion -->
	</div> <!-- /docsToc -->
	<div id="docsContent">
    	<h1>Adding a Kubernetes worker node via Docker.</h1>
		<!-- BEGIN MUNGE: UNVERSIONED_WARNING -->

<!-- END MUNGE: UNVERSIONED_WARNING -->

<h2 id="adding-a-kubernetes-worker-node-via-docker">Adding a Kubernetes worker node via Docker.</h2>

<p>These instructions are very similar to the master set-up above, but they are duplicated for clarity.
You need to repeat these instructions for each node you want to join the cluster.
We will assume that the IP address of this node is <code>${NODE_IP}</code> and you have the IP address of the master in <code>${MASTER_IP}</code> that you created in the <a href="master.html">master instructions</a>.</p>

<p>For each worker node, there are three steps:
   * <a href="#set-up-flanneld-on-the-worker-node">Set up <code>flanneld</code> on the worker node</a>
   * <a href="#start-kubernetes-on-the-worker-node">Start Kubernetes on the worker node</a>
   * <a href="#add-the-node-to-the-cluster">Add the worker to the cluster</a></p>

<h3 id="set-up-flanneld-on-the-worker-node">Set up Flanneld on the worker node</h3>

<p>As before, the Flannel daemon is going to provide network connectivity.</p>

<p><em>Note</em>:
There is a <a href="https://github.com/docker/docker/issues/14106">bug</a> in Docker 1.7.0 that prevents this from working correctly.
Please install Docker 1.6.2 or wait for Docker 1.7.1.</p>

<h4 id="set-up-a-bootstrap-docker">Set up a bootstrap docker</h4>

<p>As previously, we need a second instance of the Docker daemon running to bootstrap the flannel networking.</p>

<p>Run:</p>

<div class="highlight">
  <pre><code class="language-sh">sudo sh -c 'docker -d -H unix:///var/run/docker-bootstrap.sock -p /var/run/docker-bootstrap.pid --iptables=false --ip-masq=false --bridge=none --graph=/var/lib/docker-bootstrap 2&gt; /var/log/docker-bootstrap.log 1&gt; /dev/null &amp;'
</code></pre>
</div>

<p><em>Important Note</em>:
If you are running this on a long running system, rather than experimenting, you should run the bootstrap Docker instance under something like SysV init, upstart or systemd so that it is restarted
across reboots and failures.</p>

<h4 id="bring-down-docker">Bring down Docker</h4>

<p>To re-configure Docker to use flannel, we need to take docker down, run flannel and then restart Docker.</p>

<p>Turning down Docker is system dependent, it may be:</p>

<div class="highlight">
  <pre><code class="language-sh">sudo /etc/init.d/docker stop
</code></pre>
</div>

<p>or</p>

<div class="highlight">
  <pre><code class="language-sh">sudo systemctl stop docker
</code></pre>
</div>

<p>or it may be something else.</p>

<h4 id="run-flannel">Run flannel</h4>

<p>Now run flanneld itself, this call is slightly different from the above, since we point it at the etcd instance on the master.</p>

<div class="highlight">
  <pre><code class="language-sh">sudo docker -H unix:///var/run/docker-bootstrap.sock run -d --net=host --privileged -v /dev/net:/dev/net quay.io/coreos/flannel:0.5.0 /opt/bin/flanneld --etcd-endpoints=http://${MASTER_IP}:4001
</code></pre>
</div>

<p>The previous command should have printed a really long hash, copy this hash.</p>

<p>Now get the subnet settings from flannel:</p>

<div class="highlight">
  <pre><code class="language-sh">sudo docker -H unix:///var/run/docker-bootstrap.sock exec &lt;really-long-hash-from-above-here&gt; cat /run/flannel/subnet.env
</code></pre>
</div>

<h4 id="edit-the-docker-configuration">Edit the docker configuration</h4>

<p>You now need to edit the docker configuration to activate new flags.  Again, this is system specific.</p>

<p>This may be in <code>/etc/default/docker</code> or <code>/etc/systemd/service/docker.service</code> or it may be elsewhere.</p>

<p>Regardless, you need to add the following to the docker command line:</p>

<div class="highlight">
  <pre><code class="language-sh">--bip=${FLANNEL_SUBNET} --mtu=${FLANNEL_MTU}
</code></pre>
</div>

<h4 id="remove-the-existing-docker-bridge">Remove the existing Docker bridge</h4>

<p>Docker creates a bridge named <code>docker0</code> by default.  You need to remove this:</p>

<div class="highlight">
  <pre><code class="language-sh">sudo /sbin/ifconfig docker0 down
sudo brctl delbr docker0
</code></pre>
</div>

<p>You may need to install the <code>bridge-utils</code> package for the <code>brctl</code> binary.</p>

<h4 id="restart-docker">Restart Docker</h4>

<p>Again this is system dependent, it may be:</p>

<div class="highlight">
  <pre><code class="language-sh">sudo /etc/init.d/docker start
</code></pre>
</div>

<p>it may be:</p>

<div class="highlight">
  <pre><code class="language-sh">systemctl start docker
</code></pre>
</div>

<h3 id="start-kubernetes-on-the-worker-node">Start Kubernetes on the worker node</h3>

<h4 id="run-the-kubelet">Run the kubelet</h4>

<p>Again this is similar to the above, but the <code>--api-servers</code> now points to the master we set up in the beginning.</p>

<div class="highlight">
  <pre><code class="language-sh">sudo docker run \
    --volume=/:/rootfs:ro \
    --volume=/sys:/sys:ro \
    --volume=/dev:/dev \
    --volume=/var/lib/docker/:/var/lib/docker:rw \
    --volume=/var/lib/kubelet/:/var/lib/kubelet:rw \
    --volume=/var/run:/var/run:rw \
    --net=host \
    --privileged=true \
    --pid=host \ 
    -d \
    gcr.io/google_containers/hyperkube:v1.0.1 /hyperkube kubelet --api-servers=http://${MASTER_IP}:8080 --v=2 --address=0.0.0.0 --enable-server --hostname-override=$(hostname -i) --cluster-dns=10.0.0.10 --cluster-domain=cluster.local
</code></pre>
</div>

<h4 id="run-the-service-proxy">Run the service proxy</h4>

<p>The service proxy provides load-balancing between groups of containers defined by Kubernetes <code>Services</code></p>

<div class="highlight">
  <pre><code class="language-sh">sudo docker run -d --net=host --privileged gcr.io/google_containers/hyperkube:v1.0.1 /hyperkube proxy --master=http://${MASTER_IP}:8080 --v=2
</code></pre>
</div>

<h3 id="next-steps">Next steps</h3>

<p>Move on to <a href="testing.html">testing your cluster</a> or <a href="#adding-a-kubernetes-worker-node-via-docker">add another node</a></p>

<!-- BEGIN MUNGE: IS_VERSIONED -->
<!-- TAG IS_VERSIONED -->
<!-- END MUNGE: IS_VERSIONED -->

<!-- BEGIN MUNGE: GENERATED_ANALYTICS -->
<p><a href=""><img src="https://kubernetes-site.appspot.com/UA-36037335-10/GitHub/docs/getting-started-guides/docker-multinode/worker.md?pixel" alt="Analytics" /></a>
<!-- END MUNGE: GENERATED_ANALYTICS --></p>


	</div>
</section>


<footer>
	<main class="light-text">
		<nav>
			<a href="/getting-started.html">Getting Started</a>
			<a href="/docs.html">Documentation</a>
			<a href="http://blog.kubernetes.io/">Blog</a>
			<a href="/foobang.html">Community</a>
		</nav>
		<div class="social">
			<a href="https://twitter.com/kubernetesio" class="twitter"><span>twitter</span></a>
			<a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
			<a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
			<a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>stackoverflow</span></a>
			<a href="https://groups.google.com/forum/#!forum/google-containers" class="mailing-list"><span>Mailing List</span></a>
			<label for="wishField">I wish this page <input type="text" id="wishField" name="wishField" placeholder="made better textfield suggestions"></label>
		</div>
		<div class="center">&copy; 2016 Kubernetes</div>
	</main>
</footer>

</body>
</html>



