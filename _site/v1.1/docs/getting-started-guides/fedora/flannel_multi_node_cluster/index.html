<!Doctype html>
<html id="docs">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href='https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="/css/styles.css"/>
	<script src="/js/script.js"></script>
    <script src="/js/jquery-2.2.0.min.js"></script>
    <script src="/js/non-mini.js"></script>
    <title>Kubernetes - Kubernetes multiple nodes cluster with flannel on Fedora</title>
</head>
<body>
<div id="cellophane" onclick="kub.toggleMenu()"></div>
<header>
	<a href="/" class="logo"></a>
	<div class="nav-buttons" data-auto-burger="primary">
		<a href="/docs" class="button" id="viewDocs">View Documentation</a>
		<a href="/get-started" class="button" id="tryKubernetes">Try Kubernetes</a>
		<button id="hamburger" onclick="kub.toggleMenu()" data-auto-burger-exclude><div></div></button>
	</div>

	<nav id="mainNav">
		<main data-auto-burger="primary">
			<div class="nav-box">
				<h3><a href="">Get Started</a></h3>
				<p>Built for a multi-cloud world, public, private or hybrid. Seamlessly roll out new features.</p>
			</div>
			<div class="nav-box">
				<h3><a href="">Documentation</a></h3>
				<p>Pellentesque in ipsum id orci porta dapibus. Nulla porttitor accumsan tincidunt. </p>
			</div>
			<div class="nav-box">
				<h3><a href="">Community</a></h3>
				<p>Vestibulum ac diam sit amet quam vehicula elementum sed sit amet dui. </p>
			</div>
			<div class="nav-box">
				<h3><a href="">Blog</a></h3>
				<p>Curabitur arcu erat, accumsan id imperdiet et, porttitor at sem. Quisque velit nisi, pretium ut lacinia in. </p>
			</div>
		</main>
		<main data-auto-burger="primary">
			<div class="left">
				<h5 class="github-invite">Interested in hacking on the core Kubernetes code base?</h5>
				<a href="" class="button">View On Github</a>
			</div>

			<div class="right">
				<h5 class="github-invite">Explore the community</h5>
				<div class="social">
					<a href="https://twitter.com/kubernetesio" class="Twitter"><span>twitter</span></a>
					<a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
					<a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
					<a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>stackoverflow</span></a>
					<a href="https://groups.google.com/forum/#!forum/google-containers" class="mailing-list"><span>Mailing List</span></a>
				</div>
			</div>
			<div class="clear" style="clear: both"></div>
		</main>
	</nav>
</header>

<!--  HERO  -->
<section id="hero" class="light-text">
	<h1></h1>
	<h5></h5>
	<div id="vendorStrip" class="light-text">
		<ul>
			<li><a href="/v1.1/">GUIDES</a></li>
			<li><a href="/v1.1/reference">REFERENCE</a></li>
			<li><a href="/v1.1/samples">SAMPLES</a></li>
			<li><a href="/v1.1/support">SUPPORT</a></li>
		</ul>
		<div class="dropdown">
			<div class="readout"></div>
			<a href="/v1.1">Version 1.1</a>
			<a href="/v1.0">Version 1.0</a>
		</div>
		<input type="text" id="search" placeholder="Search the docs">
	</div>
</section>

<section id="encyclopedia">
	<div id="docsToc">
        <div class="pi-accordion">
            
            

        </div> <!-- /pi-accordion -->
	</div> <!-- /docsToc -->
	<div id="docsContent">
    	<h1>Kubernetes multiple nodes cluster with flannel on Fedora</h1>
		<h2 id="table-of-contents">Table of Contents</h2>

<div id="pageTOC" style="padding-top:15px; font-weight: bold; width: auto;"></div>

<h2 id="introduction">Introduction</h2>

<p>This document describes how to deploy Kubernetes on multiple hosts to set up a multi-node cluster and networking with flannel. Follow fedora <a href="fedora_manual_config.html">getting started guide</a> to setup 1 master (fed-master) and 2 or more nodes. Make sure that all nodes have different names (fed-node1, fed-node2 and so on) and labels (fed-node1-label, fed-node2-label, and so on) to avoid any conflict. Also make sure that the Kubernetes master host is running etcd, kube-controller-manager, kube-scheduler, and kube-apiserver services, and the nodes are running docker, kube-proxy and kubelet services. Now install flannel on Kubernetes nodes. flannel on each node configures an overlay network that docker uses. flannel runs on each node to setup a unique class-C container network.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ol>
  <li>You need 2 or more machines with Fedora installed.</li>
</ol>

<h2 id="master-setup">Master Setup</h2>

<p><strong>Perform following commands on the Kubernetes master</strong></p>

<ul>
  <li>Configure flannel by creating a <code>flannel-config.json</code> in your current directory on fed-master. flannel provides udp and vxlan among other overlay networking backend options. In this guide, we choose kernel based vxlan backend. The contents of the json are:</li>
</ul>

<div class="highlight">
  <pre><code class="language-json">{
    "Network": "18.16.0.0/16",
    "SubnetLen": 24,
    "Backend": {
        "Type": "vxlan",
        "VNI": 1
     }
}
</code></pre>
</div>

<p><strong>NOTE:</strong> Choose an IP range that is <em>NOT</em> part of the public IP address range.</p>

<ul>
  <li>Add the configuration to the etcd server on fed-master.</li>
</ul>

<div class="highlight">
  <pre><code class="language-sh">etcdctl set /coreos.com/network/config &lt; flannel-config.json
</code></pre>
</div>

<ul>
  <li>Verify the key exists in the etcd server on fed-master.</li>
</ul>

<div class="highlight">
  <pre><code class="language-sh">etcdctl get /coreos.com/network/config
</code></pre>
</div>

<h2 id="node-setup">Node Setup</h2>

<p><strong>Perform following commands on all Kubernetes nodes</strong></p>

<ul>
  <li>Edit the flannel configuration file /etc/sysconfig/flanneld as follows:</li>
</ul>

<div class="highlight">
  <pre><code class="language-sh"># Flanneld configuration options

# etcd url location.  Point this to the server where etcd runs
FLANNEL_ETCD="http://fed-master:4001"

# etcd config key.  This is the configuration key that flannel queries
# For address range assignment
FLANNEL_ETCD_KEY="/coreos.com/network"

# Any additional options that you want to pass
FLANNEL_OPTIONS=""
</code></pre>
</div>

<p><strong>Note:</strong> By default, flannel uses the interface for the default route. If you have multiple interfaces and would like to use an interface other than the default route one, you could add “-iface=” to FLANNEL_OPTIONS. For additional options, run <code>flanneld --help</code> on command line.</p>

<ul>
  <li>Enable the flannel service.</li>
</ul>

<div class="highlight">
  <pre><code class="language-sh">systemctl enable flanneld
</code></pre>
</div>

<ul>
  <li>If docker is not running, then starting flannel service is enough and skip the next step.</li>
</ul>

<div class="highlight">
  <pre><code class="language-sh">systemctl start flanneld
</code></pre>
</div>

<ul>
  <li>If docker is already running, then stop docker, delete docker bridge (docker0), start flanneld and restart docker as follows. Another alternative is to just reboot the system (<code>systemctl reboot</code>).</li>
</ul>

<div class="highlight">
  <pre><code class="language-sh">systemctl stop docker
ip link delete docker0
systemctl start flanneld
systemctl start docker
</code></pre>
</div>

<hr />

<h2 id="test-the-cluster-and-flannel-configuration"><strong>Test the cluster and flannel configuration</strong></h2>

<ul>
  <li>Now check the interfaces on the nodes. Notice there is now a flannel.1 interface, and the ip addresses of docker0 and flannel.1 interfaces are in the same network. You will notice that docker0 is assigned a subnet (18.16.29.0/24 as shown below) on each Kubernetes node out of the IP range configured above. A working output should look like this:</li>
</ul>

<div class="highlight">
  <pre><code class="language-console"># ip -4 a|grep inet
    inet 127.0.0.1/8 scope host lo
    inet 192.168.122.77/24 brd 192.168.122.255 scope global dynamic eth0
    inet 18.16.29.0/16 scope global flannel.1
    inet 18.16.29.1/24 scope global docker0
</code></pre>
</div>

<ul>
  <li>From any node in the cluster, check the cluster members by issuing a query to etcd server via curl (only partial output is shown using <code>grep -E "\{|\}|key|value"</code>). If you set up a 1 master and 3 nodes cluster, you should see one block for each node showing the subnets they have been assigned. You can associate those subnets to each node by the MAC address (VtepMAC) and IP address (Public IP) that is listed in the output.</li>
</ul>

<div class="highlight">
  <pre><code class="language-sh">curl -s http://fed-master:4001/v2/keys/coreos.com/network/subnets | python -mjson.tool
</code></pre>
</div>

<div class="highlight">
  <pre><code class="language-json">{
    "node": {
        "key": "/coreos.com/network/subnets",
            {
                "key": "/coreos.com/network/subnets/18.16.29.0-24",
                "value": "{\"PublicIP\":\"192.168.122.77\",\"BackendType\":\"vxlan\",\"BackendData\":{\"VtepMAC\":\"46:f1:d0:18:d0:65\"}}"
            },
            {
                "key": "/coreos.com/network/subnets/18.16.83.0-24",
                "value": "{\"PublicIP\":\"192.168.122.36\",\"BackendType\":\"vxlan\",\"BackendData\":{\"VtepMAC\":\"ca:38:78:fc:72:29\"}}"
            },
            {
                "key": "/coreos.com/network/subnets/18.16.90.0-24",
                "value": "{\"PublicIP\":\"192.168.122.127\",\"BackendType\":\"vxlan\",\"BackendData\":{\"VtepMAC\":\"92:e2:80:ba:2d:4d\"}}"
            }
    }
}
</code></pre>
</div>

<ul>
  <li>From all nodes, review the <code>/run/flannel/subnet.env</code> file.  This file was generated automatically by flannel.</li>
</ul>

<div class="highlight">
  <pre><code class="language-console"># cat /run/flannel/subnet.env
FLANNEL_SUBNET=18.16.29.1/24
FLANNEL_MTU=1450
FLANNEL_IPMASQ=false
</code></pre>
</div>

<ul>
  <li>
    <p>At this point, we have etcd running on the Kubernetes master, and flannel / docker running on Kubernetes nodes. Next steps are for testing cross-host container communication which will confirm that docker and flannel are configured properly.</p>
  </li>
  <li>
    <p>Issue the following commands on any 2 nodes:</p>
  </li>
</ul>

<div class="highlight">
  <pre><code class="language-console"># docker run -it fedora:latest bash
bash-4.3#
</code></pre>
</div>

<ul>
  <li>This will place you inside the container. Install iproute and iputils packages to install ip and ping utilities. Due to a <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1142311">bug</a>, it is required to modify capabilities of ping binary to work around “Operation not permitted” error.</li>
</ul>

<div class="highlight">
  <pre><code class="language-console">bash-4.3# yum -y install iproute iputils
bash-4.3# setcap cap_net_raw-ep /usr/bin/ping
</code></pre>
</div>

<ul>
  <li>Now note the IP address on the first node:</li>
</ul>

<div class="highlight">
  <pre><code class="language-console">bash-4.3# ip -4 a l eth0 | grep inet
    inet 18.16.29.4/24 scope global eth0
</code></pre>
</div>

<ul>
  <li>And also note the IP address on the other node:</li>
</ul>

<div class="highlight">
  <pre><code class="language-console">bash-4.3# ip a l eth0 | grep inet
    inet 18.16.90.4/24 scope global eth0
</code></pre>
</div>

<ul>
  <li>Now ping from the first node to the other node:</li>
</ul>

<div class="highlight">
  <pre><code class="language-console">bash-4.3# ping 18.16.90.4
PING 18.16.90.4 (18.16.90.4) 56(84) bytes of data.
64 bytes from 18.16.90.4: icmp_seq=1 ttl=62 time=0.275 ms
64 bytes from 18.16.90.4: icmp_seq=2 ttl=62 time=0.372 ms
</code></pre>
</div>

<ul>
  <li>Now Kubernetes multi-node cluster is set up with overlay networking set up by flannel.</li>
</ul>

	</div>
</section>


<footer>
	<main class="light-text">
		<nav>
			<a href="/getting-started.html">Getting Started</a>
			<a href="/docs.html">Documentation</a>
			<a href="http://blog.kubernetes.io/">Blog</a>
			<a href="/foobang.html">Community</a>
		</nav>
		<div class="social">
			<a href="https://twitter.com/kubernetesio" class="twitter"><span>twitter</span></a>
			<a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
			<a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
			<a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>stackoverflow</span></a>
			<a href="https://groups.google.com/forum/#!forum/google-containers" class="mailing-list"><span>Mailing List</span></a>
			<label for="wishField">I wish this page <input type="text" id="wishField" name="wishField" placeholder="made better textfield suggestions"></label>
		</div>
		<div class="center">&copy; 2016 Kubernetes</div>
	</main>
</footer>

</body>
</html>



