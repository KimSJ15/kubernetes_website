<!Doctype html>
<html id="docs">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href='https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="/css/styles.css"/>
	<script src="/js/script.js"></script>
    <script src="/js/jquery-2.2.0.min.js"></script>
    <script src="/js/non-mini.js"></script>
    <title>Kubernetes - Kubernetes on Azure with CoreOS and Weave</title>
</head>
<body>
<div id="cellophane" onclick="kub.toggleMenu()"></div>
<header>
	<a href="/" class="logo"></a>
	<div class="nav-buttons" data-auto-burger="primary">
		<a href="/docs" class="button" id="viewDocs">View Documentation</a>
		<a href="/get-started" class="button" id="tryKubernetes">Try Kubernetes</a>
		<button id="hamburger" onclick="kub.toggleMenu()" data-auto-burger-exclude><div></div></button>
	</div>

	<nav id="mainNav">
		<main data-auto-burger="primary">
			<div class="nav-box">
				<h3><a href="">Get Started</a></h3>
				<p>Built for a multi-cloud world, public, private or hybrid. Seamlessly roll out new features.</p>
			</div>
			<div class="nav-box">
				<h3><a href="">Documentation</a></h3>
				<p>Pellentesque in ipsum id orci porta dapibus. Nulla porttitor accumsan tincidunt. </p>
			</div>
			<div class="nav-box">
				<h3><a href="">Community</a></h3>
				<p>Vestibulum ac diam sit amet quam vehicula elementum sed sit amet dui. </p>
			</div>
			<div class="nav-box">
				<h3><a href="">Blog</a></h3>
				<p>Curabitur arcu erat, accumsan id imperdiet et, porttitor at sem. Quisque velit nisi, pretium ut lacinia in. </p>
			</div>
		</main>
		<main data-auto-burger="primary">
			<div class="left">
				<h5 class="github-invite">Interested in hacking on the core Kubernetes code base?</h5>
				<a href="" class="button">View On Github</a>
			</div>

			<div class="right">
				<h5 class="github-invite">Explore the community</h5>
				<div class="social">
					<a href="https://twitter.com/kubernetesio" class="Twitter"><span>twitter</span></a>
					<a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
					<a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
					<a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>stackoverflow</span></a>
					<a href="https://groups.google.com/forum/#!forum/google-containers" class="mailing-list"><span>Mailing List</span></a>
				</div>
			</div>
			<div class="clear" style="clear: both"></div>
		</main>
	</nav>
</header>

<!--  HERO  -->
<section id="hero" class="light-text">
	<h1>User Guides</h1>
	<h5>How to get started, and acheive tasks, using Kubernetes</h5>
	<div id="vendorStrip" class="light-text">
		<ul>
			<li><a href="/v1.1/">GUIDES</a></li>
			<li><a href="/v1.1/reference">REFERENCE</a></li>
			<li><a href="/v1.1/samples">SAMPLES</a></li>
			<li><a href="/v1.1/support">SUPPORT</a></li>
		</ul>
		<div class="dropdown">
			<div class="readout"></div>
			<a href="/v1.1">Version 1.1</a>
			<a href="/v1.0">Version 1.0</a>
		</div>
		<input type="text" id="search" placeholder="Search the docs">
	</div>
</section>

<section id="encyclopedia">
	<div id="docsToc">
        <div class="pi-accordion">
            
            
    <a class="item" data-title="Overview" href="/v1.1/" ></a>
<div class="item" data-title="Quickstarts">
  <div class="container">
    <a class="item" data-title="TODO - 5-minute Quickstart" href="/v1.1/docs/hellonode" ></a>
    <a class="item" data-title="Kubernetes 101" href="/v1.1/docs/user-guide/walkthrough/README" ></a>
    <a class="item" data-title="Kubernetes 201" href="/v1.1/docs/user-guide/walkthrough/k8s201" ></a>

  </div>
</div>
<div class="item" data-title="Running Kubernetes">
  <div class="container">
    <a class="item" data-title="Picking the Right Solution" href="/v1.1/docs/getting-started-guides/README" ></a>
<div class="item" data-title="Running Kubernetes on Your Local Machine">
  <div class="container">
    <a class="item" data-title="Running Kubernetes Locally via Docker" href="/v1.1/docs/getting-started-guides/docker" ></a>
    <a class="item" data-title="Running Kubernetes Locally via Vagrant" href="/v1.1/docs/getting-started-guides/vagrant" ></a>
    <a class="item" data-title="Running Kubernetes Locally with No VM" href="/v1.1/docs/getting-started-guides/locally" ></a>

  </div>
</div>
    <a class="item" data-title="Running Kubernetes on Google Container Engine" href="https://cloud.google.com/container-engine/docs/before-you-begin" ></a>
<div class="item" data-title="Running Kubernetes on Turn-key Cloud Solutions">
  <div class="container">
    <a class="item" data-title="Running Kubernetes on Google Compute Engine" href="/v1.1/docs/getting-started-guides/gce" ></a>
    <a class="item" data-title="Running Kubernetes on AWS EC2" href="/v1.1/docs/getting-started-guides/aws" ></a>
    <a class="item" data-title="Running Kubernetes on Azure" href="/v1.1/docs/getting-started-guides/coreos/azure/README" ></a>

  </div>
</div>
<div class="item" data-title="Running Kubernetes on Custom Solutions">
  <div class="container">
    <a class="item" data-title="Getting Started From Scratch" href="/v1.1/docs/getting-started-guides/scratch" ></a>
<div class="item" data-title="Custom Cloud Solutions">
  <div class="container">
    <a class="item" data-title="AWS or GCE on CoreOS" href="/v1.1/docs/getting-started-guides/coreos" ></a>
    <a class="item" data-title="AWS or Joyent on Ubuntu" href="/v1.1/docs/getting-started-guides/juju" ></a>
    <a class="item" data-title="Rackspace on CoreOS" href="/v1.1/docs/getting-started-guides/rackspace" ></a>

  </div>
</div>
<div class="item" data-title="On-Premise VMs">
  <div class="container">
    <a class="item" data-title="Vagrant or VMware" href="/v1.1/docs/getting-started-guides/coreos" ></a>
    <a class="item" data-title="Cloudstack" href="/v1.1/docs/getting-started-guides/cloudstack" ></a>
    <a class="item" data-title="VMWare" href="/v1.1/docs/getting-started-guides/vsphere" ></a>
    <a class="item" data-title="Juju" href="/v1.1/docs/getting-started-guides/juju" ></a>
    <a class="item" data-title="libvirt on CoreOS" href="/v1.1/docs/getting-started-guides/libvirt-coreos" ></a>
    <a class="item" data-title="oVirt" href="/v1.1/docs/getting-started-guides/ovirt" ></a>
    <a class="item" data-title="libvirt or KVM" href="/v1.1/docs/getting-started-guides/fedora/flannel_multi_node_cluster" ></a>

  </div>
</div>
<div class="item" data-title="Bare Metal">
  <div class="container">
    <a class="item" data-title="Offline" href="/v1.1/docs/getting-started-guides/coreos/bare_metal_offline" ></a>
    <a class="item" data-title="Fedora via Ansible" href="/v1.1/docs/getting-started-guides/fedora/fedora_ansible_config" ></a>
    <a class="item" data-title="Fedora (Single Node)" href="/v1.1/docs/getting-started-guides/fedora/fedora_manual_config" ></a>
    <a class="item" data-title="Fedora (Multi Node)" href="/v1.1/docs/getting-started-guides/fedora/flannel_multi_node_cluster" ></a>
    <a class="item" data-title="Centos" href="/v1.1/docs/getting-started-guides/centos/centos_manual_config" ></a>
    <a class="item" data-title="Ubuntu" href="/v1.1/docs/getting-started-guides/ubuntu" ></a>
    <a class="item" data-title="Docker (Multi Node)" href="/v1.1/docs/getting-started-guides/docker-multinode" ></a>

  </div>
</div>

  </div>
</div>

  </div>
</div>
<div class="item" data-title="Common Tasks">
  <div class="container">
    <a class="item" data-title="Using Clusters" href="/v1.1/docs/admin/introduction" ></a>
    <a class="item" data-title="Using Multiple Clusters" href="/v1.1/docs/admin/multi-cluster" ></a>
    <a class="item" data-title="Using Large Clusters" href="/v1.1/docs/admin/cluster-large" ></a>
    <a class="item" data-title="Building High-Availability Clusters" href="/v1.1/docs/admin/high-availability" ></a>
    <a class="item" data-title="Accessing Clusters" href="/v1.1/docs/user-guide/accessing-the-cluster" ></a>
    <a class="item" data-title="Sharing a Cluster" href="/v1.1/docs/admin/namespaces/README" ></a>
    <a class="item" data-title="Changing Cluster Size" href="https://github.com/kubernetes/kubernetes/wiki/User-FAQ#how-do-i-change-the-size-of-my-cluster" ></a>
    <a class="item" data-title="Creating a Custom Cluster from Scratch" href="/v1.1/docs/getting-started-guides/scratch" ></a>
    <a class="item" data-title="Authenticating Across Clusters with kubeconfig" href="/v1.1/docs/user-guide/kubeconfig-file" ></a>
    <a class="item" data-title="Using Nodes" href="/v1.1/docs/admin/node" ></a>
    <a class="item" data-title="Assigning Pods to Nodes" href="/v1.1/docs/user-guide/node-selection/README" ></a>
    <a class="item" data-title="Using Configuration Files" href="/v1.1/docs/user-guide/simple-yaml" ></a>
    <a class="item" data-title="Configuring Containers" href="/v1.1/docs/user-guide/configuring-containers" ></a>
    <a class="item" data-title="Configuring Kubernetes with Salt" href="/v1.1/docs/admin/salt" ></a>
    <a class="item" data-title="Using Environment Variables" href="/v1.1/docs/user-guide/environment-guide/README" ></a>
    <a class="item" data-title="Configuring Garbage Collection" href="/v1.1/docs/admin/garbage-collection" ></a>
    <a class="item" data-title="Managing Compute Resources" href="/v1.1/docs/user-guide/compute-resources" ></a>
    <a class="item" data-title="Applying Resource Quotas and Limits" href="/v1.1/docs/admin/resourcequota/README" ></a>
    <a class="item" data-title="Setting Pod CPU and Memory Limits" href="/v1.1/docs/admin/limitrange/README" ></a>
    <a class="item" data-title="Managing Deployments" href="/v1.1/docs/user-guide/managing-deployments" ></a>
    <a class="item" data-title="Deploying Applications" href="/v1.1/docs/user-guide/deploying-applications" ></a>
    <a class="item" data-title="Launching, Exposing, and Killing Applications" href="/v1.1/docs/user-guide/quick-start" ></a>
    <a class="item" data-title="Connecting Applications" href="/v1.1/docs/user-guide/connecting-applications" ></a>
    <a class="item" data-title="Networking in Kubernetes" href="/v1.1/docs/admin/networking" ></a>
    <a class="item" data-title="Creating Servers with External IPs" href="/v1.1/examples/simple-nginx" ></a>
    <a class="item" data-title="Setting Up and Configuring DNS" href="/v1.1/examples/cluster-dns/README" ></a>
    <a class="item" data-title="Using DNS Pods and Services" href="/v1.1/docs/admin/dns" ></a>
    <a class="item" data-title="Working with Containers" href="/v1.1/docs/user-guide/production-pods" ></a>
    <a class="item" data-title="Creating Pods with the Downward API" href="/v1.1/docs/user-guide/downward-api/README" ></a>
    <a class="item" data-title="Using Secrets" href="/v1.1/docs/user-guide/secrets/README" ></a>
    <a class="item" data-title="Using Persistent Volumes" href="/v1.1/docs/user-guide/persistent-volumes/README" ></a>
    <a class="item" data-title="Updating Live Pods" href="/v1.1/docs/user-guide/update-demo/README" ></a>

  </div>
</div>
<div class="item" data-title="Testing and Monitoring">
  <div class="container">
    <a class="item" data-title="Simulating Large Test Loads" href="/v1.1/examples/k8petstore/README" ></a>
    <a class="item" data-title="Checking Pod Health" href="/v1.1/docs/user-guide/liveness/README" ></a>
    <a class="item" data-title="Using Explorer to Examine the Runtime Environment" href="/v1.1/examples/explorer/README" ></a>
    <a class="item" data-title="Resource Usage Monitoring" href="/v1.1/docs/user-guide/monitoring" ></a>

  </div>
</div>

        </div> <!-- /pi-accordion -->
	</div> <!-- /docsToc -->
	<div id="docsContent">
    	<h1>Kubernetes on Azure with CoreOS and Weave</h1>
		<h2 id="introduction">Introduction</h2>

<p>In this guide I will demonstrate how to deploy a Kubernetes cluster to Azure cloud. You will be using CoreOS with Weave, which implements simple and secure networking, in a transparent, yet robust way. The purpose of this guide is to provide an out-of-the-box implementation that can ultimately be taken into production with little change. It will demonstrate how to provision a dedicated Kubernetes master and etcd nodes, and show how to scale the cluster with ease.</p>

<h2 id="table-of-contents">Table of Contents</h2>

<div id="pageTOC" style="padding-top:15px; font-weight: bold; width: auto;"></div>

<h3 id="prerequisites">Prerequisites</h3>

<ol>
  <li>You need an Azure account.</li>
</ol>

<h2 id="lets-go">Let’s go!</h2>

<p>To get started, you need to checkout the code:</p>

<div class="highlight">
  <pre><code class="language-sh">git clone https://github.com/kubernetes/kubernetes
cd kubernetes/docs/getting-started-guides/coreos/azure/
</code></pre>
</div>

<p>You will need to have <a href="http://nodejs.org/download/">Node.js installed</a> on you machine. If you have previously used Azure CLI, you should have it already.</p>

<p>First, you need to install some of the dependencies with</p>

<div class="highlight">
  <pre><code class="language-sh">npm install
</code></pre>
</div>

<p>Now, all you need to do is:</p>

<div class="highlight">
  <pre><code class="language-sh">./azure-login.js -u &lt;your_username&gt;
./create-kubernetes-cluster.js
</code></pre>
</div>

<p>This script will provision a cluster suitable for production use, where there is a ring of 3 dedicated etcd nodes: 1 kubernetes master and 2 kubernetes nodes. The <code>kube-00</code> VM will be the master, your work loads are only to be deployed on the nodes, <code>kube-01</code> and <code>kube-02</code>. Initially, all VMs are single-core, to ensure a user of the free tier can reproduce it without paying extra. I will show how to add more bigger VMs later.</p>

<p><img src="initial_cluster.png" alt="VMs in Azure" /></p>

<p>Once the creation of Azure VMs has finished, you should see the following:</p>

<div class="highlight">
  <pre><code class="language-console">...
azure_wrapper/info: Saved SSH config, you can use it like so: `ssh -F  ./output/kube_1c1496016083b4_ssh_conf &lt;hostname&gt;`
azure_wrapper/info: The hosts in this deployment are:
 [ 'etcd-00', 'etcd-01', 'etcd-02', 'kube-00', 'kube-01', 'kube-02' ]
azure_wrapper/info: Saved state into `./output/kube_1c1496016083b4_deployment.yml`
</code></pre>
</div>

<p>Let’s login to the master node like so:</p>

<div class="highlight">
  <pre><code class="language-sh">ssh -F  ./output/kube_1c1496016083b4_ssh_conf kube-00
</code></pre>
</div>

<blockquote>
  <p>Note: config file name will be different, make sure to use the one you see.</p>
</blockquote>

<p>Check there are 2 nodes in the cluster:</p>

<div class="highlight">
  <pre><code class="language-console">core@kube-00 ~ $ kubectl get nodes
NAME      LABELS                           STATUS
kube-01   kubernetes.io/hostname=kube-01   Ready
kube-02   kubernetes.io/hostname=kube-02   Ready
</code></pre>
</div>

<h2 id="deploying-the-workload">Deploying the workload</h2>

<p>Let’s follow the Guestbook example now:</p>

<div class="highlight">
  <pre><code class="language-sh">kubectl create -f ~/guestbook-example
</code></pre>
</div>

<p>You need to wait for the pods to get deployed, run the following and wait for <code>STATUS</code> to change from <code>Pending</code> to <code>Running</code>.</p>

<div class="highlight">
  <pre><code class="language-sh">kubectl get pods --watch
</code></pre>
</div>

<blockquote>
  <p>Note: the most time it will spend downloading Docker container images on each of the nodes.</p>
</blockquote>

<p>Eventually you should see:</p>

<div class="highlight">
  <pre><code class="language-console">NAME                READY     STATUS    RESTARTS   AGE
frontend-0a9xi      1/1       Running   0          4m
frontend-4wahe      1/1       Running   0          4m
frontend-6l36j      1/1       Running   0          4m
redis-master-talmr  1/1       Running   0          4m
redis-slave-12zfd   1/1       Running   0          4m
redis-slave-3nbce   1/1       Running   0          4m
</code></pre>
</div>

<h2 id="scaling">Scaling</h2>

<p>Two single-core nodes are certainly not enough for a production system of today. Let’s scale the cluster by adding a couple of bigger nodes.</p>

<p>You will need to open another terminal window on your machine and go to the same working directory (e.g. <code>~/Workspace/kubernetes/docs/getting-started-guides/coreos/azure/</code>).</p>

<p>First, lets set the size of new VMs:</p>

<div class="highlight">
  <pre><code class="language-sh">export AZ_VM_SIZE=Large
</code></pre>
</div>

<p>Now, run scale script with state file of the previous deployment and number of nodes to add:</p>

<div class="highlight">
  <pre><code class="language-console">core@kube-00 ~ $ ./scale-kubernetes-cluster.js ./output/kube_1c1496016083b4_deployment.yml 2
...
azure_wrapper/info: Saved SSH config, you can use it like so: `ssh -F  ./output/kube_8f984af944f572_ssh_conf &lt;hostname&gt;`
azure_wrapper/info: The hosts in this deployment are:
 [ 'etcd-00',
  'etcd-01',
  'etcd-02',
  'kube-00',
  'kube-01',
  'kube-02',
  'kube-03',
  'kube-04' ]
azure_wrapper/info: Saved state into `./output/kube_8f984af944f572_deployment.yml`
</code></pre>
</div>

<blockquote>
  <p>Note: this step has created new files in <code>./output</code>.</p>
</blockquote>

<p>Back on <code>kube-00</code>:</p>

<div class="highlight">
  <pre><code class="language-console">core@kube-00 ~ $ kubectl get nodes
NAME      LABELS                           STATUS
kube-01   kubernetes.io/hostname=kube-01   Ready
kube-02   kubernetes.io/hostname=kube-02   Ready
kube-03   kubernetes.io/hostname=kube-03   Ready
kube-04   kubernetes.io/hostname=kube-04   Ready
</code></pre>
</div>

<p>You can see that two more nodes joined happily. Let’s scale the number of Guestbook instances now.</p>

<p>First, double-check how many replication controllers there are:</p>

<div class="highlight">
  <pre><code class="language-console">core@kube-00 ~ $ kubectl get rc
ONTROLLER     CONTAINER(S)   IMAGE(S)                                    SELECTOR            REPLICAS
frontend       php-redis      kubernetes/example-guestbook-php-redis:v2   name=frontend       3
redis-master   master         redis                                       name=redis-master   1
redis-slave    worker         kubernetes/redis-slave:v2                   name=redis-slave    2
</code></pre>
</div>

<p>As there are 4 nodes, let’s scale proportionally:</p>

<div class="highlight">
  <pre><code class="language-console">core@kube-00 ~ $ kubectl scale --replicas=4 rc redis-slave
&gt;&gt;&gt;&gt;&gt;&gt;&gt; coreos/azure: Updates for 1.0
scaled
core@kube-00 ~ $ kubectl scale --replicas=4 rc frontend
scaled
</code></pre>
</div>

<p>Check what you have now:</p>

<div class="highlight">
  <pre><code class="language-console">core@kube-00 ~ $ kubectl get rc
CONTROLLER     CONTAINER(S)   IMAGE(S)                                    SELECTOR            REPLICAS
frontend       php-redis      kubernetes/example-guestbook-php-redis:v2   name=frontend       4
redis-master   master         redis                                       name=redis-master   1
redis-slave    worker         kubernetes/redis-slave:v2                   name=redis-slave    4
</code></pre>
</div>

<p>You now will have more instances of front-end Guestbook apps and Redis slaves; and, if you look up all pods labeled <code>name=frontend</code>, you should see one running on each node.</p>

<div class="highlight">
  <pre><code class="language-console">core@kube-00 ~/guestbook-example $ kubectl get pods -l name=frontend
NAME             READY     STATUS    RESTARTS   AGE
frontend-0a9xi   1/1       Running   0          22m
frontend-4wahe   1/1       Running   0          22m
frontend-6l36j   1/1       Running   0          22m
frontend-z9oxo   1/1       Running   0          41s
</code></pre>
</div>

<h2 id="exposing-the-app-to-the-outside-world">Exposing the app to the outside world</h2>

<p>There is no native Azure load-balancer support in Kubernetes 1.0, however here is how you can expose the Guestbook app to the Internet.</p>

<pre><code>
./expose_guestbook_app_port.sh ./output/kube_1c1496016083b4_ssh_conf
Guestbook app is on port 31605, will map it to port 80 on kube-00
info:    Executing command vm endpoint create
+ Getting virtual machines
+ Reading network configuration
+ Updating network configuration
info:    vm endpoint create command OK
info:    Executing command vm endpoint show
+ Getting virtual machines
data:      Name                          : tcp-80-31605
data:      Local port                    : 31605
data:      Protcol                       : tcp
data:      Virtual IP Address            : 137.117.156.164
data:      Direct server return          : Disabled
info:    vm endpoint show command OK

</code></pre>

<p>You then should be able to access it from anywhere via the Azure virtual IP for <code>kube-00</code> displayed above, i.e. <code>http://137.117.156.164/</code> in my case.</p>

<h2 id="next-steps">Next steps</h2>

<p>You now have a full-blow cluster running in Azure, congrats!</p>

<p>You should probably try deploy other <a href="../../../../examples/">example apps</a> or write your own ;)</p>

<h2 id="tear-down">Tear down…</h2>

<p>If you don’t wish care about the Azure bill, you can tear down the cluster. It’s easy to redeploy it, as you can see.</p>

<div class="highlight">
  <pre><code class="language-sh">./destroy-cluster.js ./output/kube_8f984af944f572_deployment.yml
</code></pre>
</div>

<blockquote>
  <p>Note: make sure to use the <em>latest state file</em>, as after scaling there is a new one.</p>
</blockquote>

<p>By the way, with the scripts shown, you can deploy multiple clusters, if you like :)</p>

	</div>
</section>


<footer>
	<main class="light-text">
		<nav>
			<a href="/getting-started.html">Getting Started</a>
			<a href="/docs.html">Documentation</a>
			<a href="http://blog.kubernetes.io/">Blog</a>
			<a href="/foobang.html">Community</a>
		</nav>
		<div class="social">
			<a href="https://twitter.com/kubernetesio" class="twitter"><span>twitter</span></a>
			<a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
			<a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
			<a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>stackoverflow</span></a>
			<a href="https://groups.google.com/forum/#!forum/google-containers" class="mailing-list"><span>Mailing List</span></a>
			<label for="wishField">I wish this page <input type="text" id="wishField" name="wishField" placeholder="made better textfield suggestions"></label>
		</div>
		<div class="center">&copy; 2016 Kubernetes</div>
	</main>
</footer>

</body>
</html>



