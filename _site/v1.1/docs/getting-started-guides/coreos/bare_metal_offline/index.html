<!Doctype html>
<html id="docs">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href='https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="/css/styles.css"/>
	<script src="/js/script.js"></script>
    <script src="/js/jquery-2.2.0.min.js"></script>
    <script src="/js/non-mini.js"></script>
    <title>Kubernetes - Bare Metal CoreOS with Kubernetes (OFFLINE)</title>
</head>
<body>
<div id="cellophane" onclick="kub.toggleMenu()"></div>
<header>
	<a href="/" class="logo"></a>
	<div class="nav-buttons" data-auto-burger="primary">
		<a href="/docs" class="button" id="viewDocs">View Documentation</a>
		<a href="/get-started" class="button" id="tryKubernetes">Try Kubernetes</a>
		<button id="hamburger" onclick="kub.toggleMenu()" data-auto-burger-exclude><div></div></button>
	</div>

	<nav id="mainNav">
		<main data-auto-burger="primary">
			<div class="nav-box">
				<h3><a href="">Get Started</a></h3>
				<p>Built for a multi-cloud world, public, private or hybrid. Seamlessly roll out new features.</p>
			</div>
			<div class="nav-box">
				<h3><a href="">Documentation</a></h3>
				<p>Pellentesque in ipsum id orci porta dapibus. Nulla porttitor accumsan tincidunt. </p>
			</div>
			<div class="nav-box">
				<h3><a href="">Community</a></h3>
				<p>Vestibulum ac diam sit amet quam vehicula elementum sed sit amet dui. </p>
			</div>
			<div class="nav-box">
				<h3><a href="">Blog</a></h3>
				<p>Curabitur arcu erat, accumsan id imperdiet et, porttitor at sem. Quisque velit nisi, pretium ut lacinia in. </p>
			</div>
		</main>
		<main data-auto-burger="primary">
			<div class="left">
				<h5 class="github-invite">Interested in hacking on the core Kubernetes code base?</h5>
				<a href="" class="button">View On Github</a>
			</div>

			<div class="right">
				<h5 class="github-invite">Explore the community</h5>
				<div class="social">
					<a href="https://twitter.com/kubernetesio" class="Twitter"><span>twitter</span></a>
					<a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
					<a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
					<a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>stackoverflow</span></a>
					<a href="https://groups.google.com/forum/#!forum/google-containers" class="mailing-list"><span>Mailing List</span></a>
				</div>
			</div>
			<div class="clear" style="clear: both"></div>
		</main>
	</nav>
</header>

<!--  HERO  -->
<section id="hero" class="light-text">
	<h1>User Guides</h1>
	<h5>How to get started, and acheive tasks, using Kubernetes</h5>
	<div id="vendorStrip" class="light-text">
		<ul>
			<li><a href="/v1.1/">GUIDES</a></li>
			<li><a href="/v1.1/reference">REFERENCE</a></li>
			<li><a href="/v1.1/samples">SAMPLES</a></li>
			<li><a href="/v1.1/support">SUPPORT</a></li>
		</ul>
		<div class="dropdown">
			<div class="readout"></div>
			<a href="/v1.1">Version 1.1</a>
			<a href="/v1.0">Version 1.0</a>
		</div>
		<input type="text" id="search" placeholder="Search the docs">
	</div>
</section>

<section id="encyclopedia">
	<div id="docsToc">
        <div class="pi-accordion">
            
            
    <a class="item" data-title="Overview" href="/v1.1/" ></a>
<div class="item" data-title="Quickstarts">
  <div class="container">
    <a class="item" data-title="TODO - 5-minute Quickstart" href="/v1.1/docs/hellonode" ></a>
    <a class="item" data-title="Kubernetes 101" href="/v1.1/docs/user-guide/walkthrough/README" ></a>
    <a class="item" data-title="Kubernetes 201" href="/v1.1/docs/user-guide/walkthrough/k8s201" ></a>

  </div>
</div>
<div class="item" data-title="Running Kubernetes">
  <div class="container">
    <a class="item" data-title="Picking the Right Solution" href="/v1.1/docs/getting-started-guides/README" ></a>
<div class="item" data-title="Running Kubernetes on Your Local Machine">
  <div class="container">
    <a class="item" data-title="Running Kubernetes Locally via Docker" href="/v1.1/docs/getting-started-guides/docker" ></a>
    <a class="item" data-title="Running Kubernetes Locally via Vagrant" href="/v1.1/docs/getting-started-guides/vagrant" ></a>
    <a class="item" data-title="Running Kubernetes Locally with No VM" href="/v1.1/docs/getting-started-guides/locally" ></a>

  </div>
</div>
    <a class="item" data-title="Running Kubernetes on Google Container Engine" href="https://cloud.google.com/container-engine/docs/before-you-begin" ></a>
<div class="item" data-title="Running Kubernetes on Turn-key Cloud Solutions">
  <div class="container">
    <a class="item" data-title="Running Kubernetes on Google Compute Engine" href="/v1.1/docs/getting-started-guides/gce" ></a>
    <a class="item" data-title="Running Kubernetes on AWS EC2" href="/v1.1/docs/getting-started-guides/aws" ></a>
    <a class="item" data-title="Running Kubernetes on Azure" href="/v1.1/docs/getting-started-guides/coreos/azure/README" ></a>

  </div>
</div>
<div class="item" data-title="Running Kubernetes on Custom Solutions">
  <div class="container">
    <a class="item" data-title="Getting Started From Scratch" href="/v1.1/docs/getting-started-guides/scratch" ></a>
<div class="item" data-title="Custom Cloud Solutions">
  <div class="container">
    <a class="item" data-title="AWS or GCE on CoreOS" href="/v1.1/docs/getting-started-guides/coreos" ></a>
    <a class="item" data-title="AWS or Joyent on Ubuntu" href="/v1.1/docs/getting-started-guides/juju" ></a>
    <a class="item" data-title="Rackspace on CoreOS" href="/v1.1/docs/getting-started-guides/rackspace" ></a>

  </div>
</div>
<div class="item" data-title="On-Premise VMs">
  <div class="container">
    <a class="item" data-title="Vagrant or VMware" href="/v1.1/docs/getting-started-guides/coreos" ></a>
    <a class="item" data-title="Cloudstack" href="/v1.1/docs/getting-started-guides/cloudstack" ></a>
    <a class="item" data-title="VMWare" href="/v1.1/docs/getting-started-guides/vsphere" ></a>
    <a class="item" data-title="Juju" href="/v1.1/docs/getting-started-guides/juju" ></a>
    <a class="item" data-title="libvirt on CoreOS" href="/v1.1/docs/getting-started-guides/libvirt-coreos" ></a>
    <a class="item" data-title="oVirt" href="/v1.1/docs/getting-started-guides/ovirt" ></a>
    <a class="item" data-title="libvirt or KVM" href="/v1.1/docs/getting-started-guides/fedora/flannel_multi_node_cluster" ></a>

  </div>
</div>
<div class="item" data-title="Bare Metal">
  <div class="container">
    <a class="item" data-title="Offline" href="/v1.1/docs/getting-started-guides/coreos/bare_metal_offline" ></a>
    <a class="item" data-title="Fedora via Ansible" href="/v1.1/docs/getting-started-guides/fedora/fedora_ansible_config" ></a>
    <a class="item" data-title="Fedora (Single Node)" href="/v1.1/docs/getting-started-guides/fedora/fedora_manual_config" ></a>
    <a class="item" data-title="Fedora (Multi Node)" href="/v1.1/docs/getting-started-guides/fedora/flannel_multi_node_cluster" ></a>
    <a class="item" data-title="Centos" href="/v1.1/docs/getting-started-guides/centos/centos_manual_config" ></a>
    <a class="item" data-title="Ubuntu" href="/v1.1/docs/getting-started-guides/ubuntu" ></a>
    <a class="item" data-title="Docker (Multi Node)" href="/v1.1/docs/getting-started-guides/docker-multinode" ></a>

  </div>
</div>

  </div>
</div>

  </div>
</div>
<div class="item" data-title="Common Tasks">
  <div class="container">
    <a class="item" data-title="Using Clusters" href="/v1.1/docs/admin/introduction" ></a>
    <a class="item" data-title="Using Multiple Clusters" href="/v1.1/docs/admin/multi-cluster" ></a>
    <a class="item" data-title="Using Large Clusters" href="/v1.1/docs/admin/cluster-large" ></a>
    <a class="item" data-title="Building High-Availability Clusters" href="/v1.1/docs/admin/high-availability" ></a>
    <a class="item" data-title="Accessing Clusters" href="/v1.1/docs/user-guide/accessing-the-cluster" ></a>
    <a class="item" data-title="Sharing a Cluster" href="/v1.1/docs/admin/namespaces/README" ></a>
    <a class="item" data-title="Changing Cluster Size" href="https://github.com/kubernetes/kubernetes/wiki/User-FAQ#how-do-i-change-the-size-of-my-cluster" ></a>
    <a class="item" data-title="Creating a Custom Cluster from Scratch" href="/v1.1/docs/getting-started-guides/scratch" ></a>
    <a class="item" data-title="Authenticating Across Clusters with kubeconfig" href="/v1.1/docs/user-guide/kubeconfig-file" ></a>
    <a class="item" data-title="Using Nodes" href="/v1.1/docs/admin/node" ></a>
    <a class="item" data-title="Assigning Pods to Nodes" href="/v1.1/docs/user-guide/node-selection/README" ></a>
    <a class="item" data-title="Using Configuration Files" href="/v1.1/docs/user-guide/simple-yaml" ></a>
    <a class="item" data-title="Configuring Containers" href="/v1.1/docs/user-guide/configuring-containers" ></a>
    <a class="item" data-title="Configuring Kubernetes with Salt" href="/v1.1/docs/admin/salt" ></a>
    <a class="item" data-title="Using Environment Variables" href="/v1.1/docs/user-guide/environment-guide/README" ></a>
    <a class="item" data-title="Configuring Garbage Collection" href="/v1.1/docs/admin/garbage-collection" ></a>
    <a class="item" data-title="Managing Compute Resources" href="/v1.1/docs/user-guide/compute-resources" ></a>
    <a class="item" data-title="Applying Resource Quotas and Limits" href="/v1.1/docs/admin/resourcequota/README" ></a>
    <a class="item" data-title="Setting Pod CPU and Memory Limits" href="/v1.1/docs/admin/limitrange/README" ></a>
    <a class="item" data-title="Managing Deployments" href="/v1.1/docs/user-guide/managing-deployments" ></a>
    <a class="item" data-title="Deploying Applications" href="/v1.1/docs/user-guide/deploying-applications" ></a>
    <a class="item" data-title="Launching, Exposing, and Killing Applications" href="/v1.1/docs/user-guide/quick-start" ></a>
    <a class="item" data-title="Connecting Applications" href="/v1.1/docs/user-guide/connecting-applications" ></a>
    <a class="item" data-title="Networking in Kubernetes" href="/v1.1/docs/admin/networking" ></a>
    <a class="item" data-title="Creating Servers with External IPs" href="/v1.1/examples/simple-nginx" ></a>
    <a class="item" data-title="Setting Up and Configuring DNS" href="/v1.1/examples/cluster-dns/README" ></a>
    <a class="item" data-title="Using DNS Pods and Services" href="/v1.1/docs/admin/dns" ></a>
    <a class="item" data-title="Working with Containers" href="/v1.1/docs/user-guide/production-pods" ></a>
    <a class="item" data-title="Creating Pods with the Downward API" href="/v1.1/docs/user-guide/downward-api/README" ></a>
    <a class="item" data-title="Using Secrets" href="/v1.1/docs/user-guide/secrets/README" ></a>
    <a class="item" data-title="Using Persistent Volumes" href="/v1.1/docs/user-guide/persistent-volumes/README" ></a>
    <a class="item" data-title="Updating Live Pods" href="/v1.1/docs/user-guide/update-demo/README" ></a>

  </div>
</div>
<div class="item" data-title="Testing and Monitoring">
  <div class="container">
    <a class="item" data-title="Simulating Large Test Loads" href="/v1.1/examples/k8petstore/README" ></a>
    <a class="item" data-title="Checking Pod Health" href="/v1.1/docs/user-guide/liveness/README" ></a>
    <a class="item" data-title="Using Explorer to Examine the Runtime Environment" href="/v1.1/examples/explorer/README" ></a>
    <a class="item" data-title="Resource Usage Monitoring" href="/v1.1/docs/user-guide/monitoring" ></a>

  </div>
</div>

        </div> <!-- /pi-accordion -->
	</div> <!-- /docsToc -->
	<div id="docsContent">
    	<h1>Bare Metal CoreOS with Kubernetes (OFFLINE)</h1>
		<p>Deploy a CoreOS running Kubernetes environment. This particular guild is made to help those in an OFFLINE system, wither for testing a POC before the real deal, or you are restricted to be totally offline for your applications.</p>

<h2 id="table-of-contents">Table of Contents</h2>

<div id="pageTOC" style="padding-top:15px; font-weight: bold; width: auto;"></div>

<h2 id="prerequisites">Prerequisites</h2>

<ol>
  <li>Installed <em>CentOS 6</em> for PXE server</li>
  <li>At least two bare metal nodes to work with</li>
</ol>

<h2 id="high-level-design">High Level Design</h2>

<ol>
  <li>Manage the tftp directory
    <ul>
      <li>/tftpboot/(coreos)(centos)(RHEL)</li>
      <li>/tftpboot/pxelinux.0/(MAC) -&gt; linked to Linux image config file</li>
    </ul>
  </li>
  <li>Update per install the link for pxelinux</li>
  <li>Update the DHCP config to reflect the host needing deployment</li>
  <li>Setup nodes to deploy CoreOS creating a etcd cluster.</li>
  <li>Have no access to the public <a href="https://discovery.etcd.io/">etcd discovery tool</a>.</li>
  <li>Installing the CoreOS slaves to become Kubernetes nodes.</li>
</ol>

<h2 id="this-guides-variables">This Guides variables</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Node Description</th>
      <th style="text-align: center">MAC</th>
      <th style="text-align: center">IP</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">CoreOS/etcd/Kubernetes Master</td>
      <td style="text-align: center">d0:00:67:13:0d:00</td>
      <td style="text-align: center">10.20.30.40</td>
    </tr>
    <tr>
      <td style="text-align: left">CoreOS Slave 1</td>
      <td style="text-align: center">d0:00:67:13:0d:01</td>
      <td style="text-align: center">10.20.30.41</td>
    </tr>
    <tr>
      <td style="text-align: left">CoreOS Slave 2</td>
      <td style="text-align: center">d0:00:67:13:0d:02</td>
      <td style="text-align: center">10.20.30.42</td>
    </tr>
  </tbody>
</table>

<h2 id="setup-pxelinux-centos">Setup PXELINUX CentOS</h2>

<p>To setup CentOS PXELINUX environment there is a complete <a href="http://docs.fedoraproject.org/en-US/Fedora/7/html/Installation_Guide/ap-pxe-server.html">guide here</a>. This section is the abbreviated version.</p>

<ol>
  <li>
    <p>Install packages needed on CentOS</p>

    <pre><code> sudo yum install tftp-server dhcp syslinux
</code></pre>
  </li>
  <li>
    <p><code>vi /etc/xinetd.d/tftp</code> to enable tftp service and change disable to ‘no’
     disable = no</p>
  </li>
  <li>
    <p>Copy over the syslinux images we will need.</p>

    <pre><code> su -
 mkdir -p /tftpboot
 cd /tftpboot
 cp /usr/share/syslinux/pxelinux.0 /tftpboot
 cp /usr/share/syslinux/menu.c32 /tftpboot
 cp /usr/share/syslinux/memdisk /tftpboot
 cp /usr/share/syslinux/mboot.c32 /tftpboot
 cp /usr/share/syslinux/chain.c32 /tftpboot

 /sbin/service dhcpd start
 /sbin/service xinetd start
 /sbin/chkconfig tftp on
</code></pre>
  </li>
  <li>
    <p>Setup default boot menu</p>

    <pre><code> mkdir /tftpboot/pxelinux.cfg
 touch /tftpboot/pxelinux.cfg/default
</code></pre>
  </li>
  <li>
    <p>Edit the menu <code>vi /tftpboot/pxelinux.cfg/default</code></p>

    <pre><code> default menu.c32
 prompt 0
 timeout 15
 ONTIMEOUT local
 display boot.msg

 MENU TITLE Main Menu

 LABEL local
         MENU LABEL Boot local hard drive
         LOCALBOOT 0
</code></pre>
  </li>
</ol>

<p>Now you should have a working PXELINUX setup to image CoreOS nodes. You can verify the services by using VirtualBox locally or with bare metal servers.</p>

<h2 id="adding-coreos-to-pxe">Adding CoreOS to PXE</h2>

<p>This section describes how to setup the CoreOS images to live alongside a pre-existing PXELINUX environment.</p>

<ol>
  <li>Find or create the TFTP root directory that everything will be based off of.
    <ul>
      <li>For this document we will assume <code>/tftpboot/</code> is our root directory.</li>
    </ul>
  </li>
  <li>Once we know and have our tftp root directory we will create a new directory structure for our CoreOS images.</li>
  <li>
    <p>Download the CoreOS PXE files provided by the CoreOS team.</p>

    <pre><code> MY_TFTPROOT_DIR=/tftpboot
 mkdir -p $MY_TFTPROOT_DIR/images/coreos/
 cd $MY_TFTPROOT_DIR/images/coreos/
 wget http://stable.release.core-os.net/amd64-usr/current/coreos_production_pxe.vmlinuz
 wget http://stable.release.core-os.net/amd64-usr/current/coreos_production_pxe.vmlinuz.sig
 wget http://stable.release.core-os.net/amd64-usr/current/coreos_production_pxe_image.cpio.gz
 wget http://stable.release.core-os.net/amd64-usr/current/coreos_production_pxe_image.cpio.gz.sig
 gpg --verify coreos_production_pxe.vmlinuz.sig
 gpg --verify coreos_production_pxe_image.cpio.gz.sig
</code></pre>
  </li>
  <li>
    <p>Edit the menu <code>vi /tftpboot/pxelinux.cfg/default</code> again</p>

    <pre><code> default menu.c32
 prompt 0
 timeout 300
 ONTIMEOUT local
 display boot.msg

 MENU TITLE Main Menu

 LABEL local
         MENU LABEL Boot local hard drive
         LOCALBOOT 0

 MENU BEGIN CoreOS Menu

     LABEL coreos-master
         MENU LABEL CoreOS Master
         KERNEL images/coreos/coreos_production_pxe.vmlinuz
         APPEND initrd=images/coreos/coreos_production_pxe_image.cpio.gz cloud-config-url=http://&lt;xxx.xxx.xxx.xxx&gt;/pxe-cloud-config-single-master.yml

     LABEL coreos-slave
         MENU LABEL CoreOS Slave
         KERNEL images/coreos/coreos_production_pxe.vmlinuz
         APPEND initrd=images/coreos/coreos_production_pxe_image.cpio.gz cloud-config-url=http://&lt;xxx.xxx.xxx.xxx&gt;/pxe-cloud-config-slave.yml
 MENU END
</code></pre>
  </li>
</ol>

<p>This configuration file will now boot from local drive but have the option to PXE image CoreOS.</p>

<h2 id="dhcp-configuration">DHCP configuration</h2>

<p>This section covers configuring the DHCP server to hand out our new images. In this case we are assuming that there are other servers that will boot alongside other images.</p>

<ol>
  <li>
    <p>Add the <code>filename</code> to the <em>host</em> or <em>subnet</em> sections.</p>

    <pre><code> filename "/tftpboot/pxelinux.0";
</code></pre>
  </li>
  <li>
    <p>At this point we want to make pxelinux configuration files that will be the templates for the different CoreOS deployments.</p>

    <pre><code> subnet 10.20.30.0 netmask 255.255.255.0 {
         next-server 10.20.30.242;
         option broadcast-address 10.20.30.255;
         filename "&lt;other default image&gt;";

         ...
         # http://www.syslinux.org/wiki/index.php/PXELINUX
         host core_os_master {
                 hardware ethernet d0:00:67:13:0d:00;
                 option routers 10.20.30.1;
                 fixed-address 10.20.30.40;
                 option domain-name-servers 10.20.30.242;
                 filename "/pxelinux.0";
         }
         host core_os_slave {
                 hardware ethernet d0:00:67:13:0d:01;
                 option routers 10.20.30.1;
                 fixed-address 10.20.30.41;
                 option domain-name-servers 10.20.30.242;
                 filename "/pxelinux.0";
         }
         host core_os_slave2 {
                 hardware ethernet d0:00:67:13:0d:02;
                 option routers 10.20.30.1;
                 fixed-address 10.20.30.42;
                 option domain-name-servers 10.20.30.242;
                 filename "/pxelinux.0";
         }
         ...
 }
</code></pre>
  </li>
</ol>

<p>We will be specifying the node configuration later in the guide.</p>

<h2 id="kubernetes">Kubernetes</h2>

<p>To deploy our configuration we need to create an <code>etcd</code> master. To do so we want to pxe CoreOS with a specific cloud-config.yml. There are two options we have here.
1. Is to template the cloud config file and programmatically create new static configs for different cluster setups.
2. Have a service discovery protocol running in our stack to do auto discovery.</p>

<p>This demo we just make a static single <code>etcd</code> server to host our Kubernetes and <code>etcd</code> master servers.</p>

<p>Since we are OFFLINE here most of the helping processes in CoreOS and Kubernetes are then limited. To do our setup we will then have to download and serve up our binaries for Kubernetes in our local environment.</p>

<p>An easy solution is to host a small web server on the DHCP/TFTP host for all our binaries to make them available to the local CoreOS PXE machines.</p>

<p>To get this up and running we are going to setup a simple <code>apache</code> server to serve our binaries needed to bootstrap Kubernetes.</p>

<p>This is on the PXE server from the previous section:</p>

<pre><code>rm /etc/httpd/conf.d/welcome.conf
cd /var/www/html/
wget -O kube-register  https://github.com/kelseyhightower/kube-register/releases/download/v0.0.2/kube-register-0.0.2-linux-amd64
wget -O setup-network-environment https://github.com/kelseyhightower/setup-network-environment/releases/download/v1.0.0/setup-network-environment
wget https://storage.googleapis.com/kubernetes-release/release/v0.15.0/bin/linux/amd64/kubernetes --no-check-certificate
wget https://storage.googleapis.com/kubernetes-release/release/v0.15.0/bin/linux/amd64/kube-apiserver --no-check-certificate
wget https://storage.googleapis.com/kubernetes-release/release/v0.15.0/bin/linux/amd64/kube-controller-manager --no-check-certificate
wget https://storage.googleapis.com/kubernetes-release/release/v0.15.0/bin/linux/amd64/kube-scheduler --no-check-certificate
wget https://storage.googleapis.com/kubernetes-release/release/v0.15.0/bin/linux/amd64/kubectl --no-check-certificate
wget https://storage.googleapis.com/kubernetes-release/release/v0.15.0/bin/linux/amd64/kubecfg --no-check-certificate
wget https://storage.googleapis.com/kubernetes-release/release/v0.15.0/bin/linux/amd64/kubelet --no-check-certificate
wget https://storage.googleapis.com/kubernetes-release/release/v0.15.0/bin/linux/amd64/kube-proxy --no-check-certificate
wget -O flanneld https://storage.googleapis.com/k8s/flanneld --no-check-certificate
</code></pre>

<p>This sets up our binaries we need to run Kubernetes. This would need to be enhanced to download from the Internet for updates in the future.</p>

<p>Now for the good stuff!</p>

<h2 id="cloud-configs">Cloud Configs</h2>

<p>The following config files are tailored for the OFFLINE version of a Kubernetes deployment.</p>

<p>These are based on the work found here: <a href="cloud-configs/master.yaml">master.yml</a>, <a href="cloud-configs/node.yaml">node.yml</a></p>

<p>To make the setup work, you need to replace a few placeholders:</p>

<ul>
  <li>Replace <code>&lt;PXE_SERVER_IP&gt;</code> with your PXE server ip address (e.g. 10.20.30.242)</li>
  <li>Replace <code>&lt;MASTER_SERVER_IP&gt;</code> with the Kubernetes master ip address (e.g. 10.20.30.40)</li>
  <li>If you run a private docker registry, replace <code>rdocker.example.com</code> with your docker registry dns name.</li>
  <li>If you use a proxy, replace <code>rproxy.example.com</code> with your proxy server (and port)</li>
  <li>Add your own SSH public key(s) to the cloud config at the end</li>
</ul>

<h3 id="masteryml">master.yml</h3>

<p>On the PXE server make and fill in the variables <code>vi /var/www/html/coreos/pxe-cloud-config-master.yml</code>.</p>

<pre><code>#cloud-config
---
write_files:
  - path: /opt/bin/waiter.sh
    owner: root
    content: |
      #! /usr/bin/bash
      until curl http://127.0.0.1:4001/v2/machines; do sleep 2; done
  - path: /opt/bin/kubernetes-download.sh
    owner: root
    permissions: 0755
    content: |
      #! /usr/bin/bash
      /usr/bin/wget -N -P "/opt/bin" "http://&lt;PXE_SERVER_IP&gt;/kubectl"
      /usr/bin/wget -N -P "/opt/bin" "http://&lt;PXE_SERVER_IP&gt;/kubernetes"
      /usr/bin/wget -N -P "/opt/bin" "http://&lt;PXE_SERVER_IP&gt;/kubecfg"
      chmod +x /opt/bin/*
  - path: /etc/profile.d/opt-path.sh
    owner: root
    permissions: 0755
    content: |
      #! /usr/bin/bash
      PATH=$PATH/opt/bin
coreos:
  units:
    - name: 10-eno1.network
      runtime: true
      content: |
        [Match]
        Name=eno1
        [Network]
        DHCP=yes
    - name: 20-nodhcp.network
      runtime: true
      content: |
        [Match]
        Name=en*
        [Network]
        DHCP=none
    - name: get-kube-tools.service
      runtime: true
      command: start
      content: |
        [Service]
        ExecStartPre=-/usr/bin/mkdir -p /opt/bin
        ExecStart=/opt/bin/kubernetes-download.sh
        RemainAfterExit=yes
        Type=oneshot
    - name: setup-network-environment.service
      command: start
      content: |
        [Unit]
        Description=Setup Network Environment
        Documentation=https://github.com/kelseyhightower/setup-network-environment
        Requires=network-online.target
        After=network-online.target
        [Service]
        ExecStartPre=-/usr/bin/mkdir -p /opt/bin
        ExecStartPre=/usr/bin/wget -N -P /opt/bin http://&lt;PXE_SERVER_IP&gt;/setup-network-environment
        ExecStartPre=/usr/bin/chmod +x /opt/bin/setup-network-environment
        ExecStart=/opt/bin/setup-network-environment
        RemainAfterExit=yes
        Type=oneshot
    - name: etcd.service
      command: start
      content: |
        [Unit]
        Description=etcd
        Requires=setup-network-environment.service
        After=setup-network-environment.service
        [Service]
        EnvironmentFile=/etc/network-environment
        User=etcd
        PermissionsStartOnly=true
        ExecStart=/usr/bin/etcd \
        --name ${DEFAULT_IPV4} \
        --addr ${DEFAULT_IPV4}:4001 \
        --bind-addr 0.0.0.0 \
        --cluster-active-size 1 \
        --data-dir /var/lib/etcd \
        --http-read-timeout 86400 \
        --peer-addr ${DEFAULT_IPV4}:7001 \
        --snapshot true
        Restart=always
        RestartSec=10s
    - name: fleet.socket
      command: start
      content: |
        [Socket]
        ListenStream=/var/run/fleet.sock
    - name: fleet.service
      command: start
      content: |
        [Unit]
        Description=fleet daemon
        Wants=etcd.service
        After=etcd.service
        Wants=fleet.socket
        After=fleet.socket
        [Service]
        Environment="FLEET_ETCD_SERVERS=http://127.0.0.1:4001"
        Environment="FLEET_METADATA=role=master"
        ExecStart=/usr/bin/fleetd
        Restart=always
        RestartSec=10s
    - name: etcd-waiter.service
      command: start
      content: |
        [Unit]
        Description=etcd waiter
        Wants=network-online.target
        Wants=etcd.service
        After=etcd.service
        After=network-online.target
        Before=flannel.service
        Before=setup-network-environment.service
        [Service]
        ExecStartPre=/usr/bin/chmod +x /opt/bin/waiter.sh
        ExecStart=/usr/bin/bash /opt/bin/waiter.sh
        RemainAfterExit=true
        Type=oneshot
    - name: flannel.service
      command: start
      content: |
        [Unit]
        Wants=etcd-waiter.service
        After=etcd-waiter.service
        Requires=etcd.service
        After=etcd.service
        After=network-online.target
        Wants=network-online.target
        Description=flannel is an etcd backed overlay network for containers
        [Service]
        Type=notify
        ExecStartPre=-/usr/bin/mkdir -p /opt/bin
        ExecStartPre=/usr/bin/wget -N -P /opt/bin http://&lt;PXE_SERVER_IP&gt;/flanneld
        ExecStartPre=/usr/bin/chmod +x /opt/bin/flanneld
        ExecStartPre=-/usr/bin/etcdctl mk /coreos.com/network/config '{"Network":"10.100.0.0/16", "Backend": {"Type": "vxlan"}}'
        ExecStart=/opt/bin/flanneld
    - name: kube-apiserver.service
      command: start
      content: |
        [Unit]
        Description=Kubernetes API Server
        Documentation=https://github.com/kubernetes/kubernetes
        Requires=etcd.service
        After=etcd.service
        [Service]
        ExecStartPre=-/usr/bin/mkdir -p /opt/bin
        ExecStartPre=/usr/bin/wget -N -P /opt/bin http://&lt;PXE_SERVER_IP&gt;/kube-apiserver
        ExecStartPre=/usr/bin/chmod +x /opt/bin/kube-apiserver
        ExecStart=/opt/bin/kube-apiserver \
        --address=0.0.0.0 \
        --port=8080 \
        --service-cluster-ip-range=10.100.0.0/16 \
        --etcd-servers=http://127.0.0.1:4001 \
        --logtostderr=true
        Restart=always
        RestartSec=10
    - name: kube-controller-manager.service
      command: start
      content: |
        [Unit]
        Description=Kubernetes Controller Manager
        Documentation=https://github.com/kubernetes/kubernetes
        Requires=kube-apiserver.service
        After=kube-apiserver.service
        [Service]
        ExecStartPre=/usr/bin/wget -N -P /opt/bin http://&lt;PXE_SERVER_IP&gt;/kube-controller-manager
        ExecStartPre=/usr/bin/chmod +x /opt/bin/kube-controller-manager
        ExecStart=/opt/bin/kube-controller-manager \
        --master=127.0.0.1:8080 \
        --logtostderr=true
        Restart=always
        RestartSec=10
    - name: kube-scheduler.service
      command: start
      content: |
        [Unit]
        Description=Kubernetes Scheduler
        Documentation=https://github.com/kubernetes/kubernetes
        Requires=kube-apiserver.service
        After=kube-apiserver.service
        [Service]
        ExecStartPre=/usr/bin/wget -N -P /opt/bin http://&lt;PXE_SERVER_IP&gt;/kube-scheduler
        ExecStartPre=/usr/bin/chmod +x /opt/bin/kube-scheduler
        ExecStart=/opt/bin/kube-scheduler --master=127.0.0.1:8080
        Restart=always
        RestartSec=10
    - name: kube-register.service
      command: start
      content: |
        [Unit]
        Description=Kubernetes Registration Service
        Documentation=https://github.com/kelseyhightower/kube-register
        Requires=kube-apiserver.service
        After=kube-apiserver.service
        Requires=fleet.service
        After=fleet.service
        [Service]
        ExecStartPre=/usr/bin/wget -N -P /opt/bin http://&lt;PXE_SERVER_IP&gt;/kube-register
        ExecStartPre=/usr/bin/chmod +x /opt/bin/kube-register
        ExecStart=/opt/bin/kube-register \
        --metadata=role=node \
        --fleet-endpoint=unix:///var/run/fleet.sock \
        --healthz-port=10248 \
        --api-endpoint=http://127.0.0.1:8080
        Restart=always
        RestartSec=10
  update:
    group: stable
    reboot-strategy: off
ssh_authorized_keys:
  - ssh-rsa AAAAB3NzaC1yc2EAAAAD...
</code></pre>

<h3 id="nodeyml">node.yml</h3>

<p>On the PXE server make and fill in the variables <code>vi /var/www/html/coreos/pxe-cloud-config-slave.yml</code>.</p>

<pre><code>#cloud-config
---
write_files:
  - path: /etc/default/docker
    content: |
      DOCKER_EXTRA_OPTS='--insecure-registry="rdocker.example.com:5000"'
coreos:
  units:
    - name: 10-eno1.network
      runtime: true
      content: |
        [Match]
        Name=eno1
        [Network]
        DHCP=yes
    - name: 20-nodhcp.network
      runtime: true
      content: |
        [Match]
        Name=en*
        [Network]
        DHCP=none
    - name: etcd.service
      mask: true
    - name: docker.service
      drop-ins:
        - name: 50-insecure-registry.conf
          content: |
            [Service]
            Environment="HTTP_PROXY=http://rproxy.example.com:3128/" "NO_PROXY=localhost,127.0.0.0/8,rdocker.example.com"
    - name: fleet.service
      command: start
      content: |
        [Unit]
        Description=fleet daemon
        Wants=fleet.socket
        After=fleet.socket
        [Service]
        Environment="FLEET_ETCD_SERVERS=http://&lt;MASTER_SERVER_IP&gt;:4001"
        Environment="FLEET_METADATA=role=node"
        ExecStart=/usr/bin/fleetd
        Restart=always
        RestartSec=10s
    - name: flannel.service
      command: start
      content: |
        [Unit]
        After=network-online.target
        Wants=network-online.target
        Description=flannel is an etcd backed overlay network for containers
        [Service]
        Type=notify
        ExecStartPre=-/usr/bin/mkdir -p /opt/bin
        ExecStartPre=/usr/bin/wget -N -P /opt/bin http://&lt;PXE_SERVER_IP&gt;/flanneld
        ExecStartPre=/usr/bin/chmod +x /opt/bin/flanneld
        ExecStart=/opt/bin/flanneld -etcd-endpoints http://&lt;MASTER_SERVER_IP&gt;:4001
    - name: docker.service
      command: start
      content: |
        [Unit]
        After=flannel.service
        Wants=flannel.service
        Description=Docker Application Container Engine
        Documentation=http://docs.docker.io
        [Service]
        EnvironmentFile=-/etc/default/docker
        EnvironmentFile=/run/flannel/subnet.env
        ExecStartPre=/bin/mount --make-rprivate /
        ExecStart=/usr/bin/docker -d --bip=${FLANNEL_SUBNET} --mtu=${FLANNEL_MTU} -s=overlay -H fd:// ${DOCKER_EXTRA_OPTS}
        [Install]
        WantedBy=multi-user.target
    - name: setup-network-environment.service
      command: start
      content: |
        [Unit]
        Description=Setup Network Environment
        Documentation=https://github.com/kelseyhightower/setup-network-environment
        Requires=network-online.target
        After=network-online.target
        [Service]
        ExecStartPre=-/usr/bin/mkdir -p /opt/bin
        ExecStartPre=/usr/bin/wget -N -P /opt/bin http://&lt;PXE_SERVER_IP&gt;/setup-network-environment
        ExecStartPre=/usr/bin/chmod +x /opt/bin/setup-network-environment
        ExecStart=/opt/bin/setup-network-environment
        RemainAfterExit=yes
        Type=oneshot
    - name: kube-proxy.service
      command: start
      content: |
        [Unit]
        Description=Kubernetes Proxy
        Documentation=https://github.com/kubernetes/kubernetes
        Requires=setup-network-environment.service
        After=setup-network-environment.service
        [Service]
        ExecStartPre=/usr/bin/wget -N -P /opt/bin http://&lt;PXE_SERVER_IP&gt;/kube-proxy
        ExecStartPre=/usr/bin/chmod +x /opt/bin/kube-proxy
        ExecStart=/opt/bin/kube-proxy \
        --etcd-servers=http://&lt;MASTER_SERVER_IP&gt;:4001 \
        --logtostderr=true
        Restart=always
        RestartSec=10
    - name: kube-kubelet.service
      command: start
      content: |
        [Unit]
        Description=Kubernetes Kubelet
        Documentation=https://github.com/kubernetes/kubernetes
        Requires=setup-network-environment.service
        After=setup-network-environment.service
        [Service]
        EnvironmentFile=/etc/network-environment
        ExecStartPre=/usr/bin/wget -N -P /opt/bin http://&lt;PXE_SERVER_IP&gt;/kubelet
        ExecStartPre=/usr/bin/chmod +x /opt/bin/kubelet
        ExecStart=/opt/bin/kubelet \
        --address=0.0.0.0 \
        --port=10250 \
        --hostname-override=${DEFAULT_IPV4} \
        --api-servers=&lt;MASTER_SERVER_IP&gt;:8080 \
        --healthz-bind-address=0.0.0.0 \
        --healthz-port=10248 \
        --logtostderr=true
        Restart=always
        RestartSec=10
  update:
    group: stable
    reboot-strategy: off
ssh_authorized_keys:
  - ssh-rsa AAAAB3NzaC1yc2EAAAAD...
</code></pre>

<h2 id="new-pxelinuxcfg-file">New pxelinux.cfg file</h2>

<p>Create a pxelinux target file for a <em>slave</em> node: <code>vi /tftpboot/pxelinux.cfg/coreos-node-slave</code></p>

<pre><code>default coreos
prompt 1
timeout 15

display boot.msg

label coreos
  menu default
  kernel images/coreos/coreos_production_pxe.vmlinuz
  append initrd=images/coreos/coreos_production_pxe_image.cpio.gz cloud-config-url=http://&lt;pxe-host-ip&gt;/coreos/pxe-cloud-config-slave.yml console=tty0 console=ttyS0 coreos.autologin=tty1 coreos.autologin=ttyS0
</code></pre>

<p>And one for the <em>master</em> node: <code>vi /tftpboot/pxelinux.cfg/coreos-node-master</code></p>

<pre><code>default coreos
prompt 1
timeout 15

display boot.msg

label coreos
  menu default
  kernel images/coreos/coreos_production_pxe.vmlinuz
  append initrd=images/coreos/coreos_production_pxe_image.cpio.gz cloud-config-url=http://&lt;pxe-host-ip&gt;/coreos/pxe-cloud-config-master.yml console=tty0 console=ttyS0 coreos.autologin=tty1 coreos.autologin=ttyS0
</code></pre>

<h2 id="specify-the-pxelinux-targets">Specify the pxelinux targets</h2>

<p>Now that we have our new targets setup for master and slave we want to configure the specific hosts to those targets. We will do this by using the pxelinux mechanism of setting a specific MAC addresses to a specific pxelinux.cfg file.</p>

<p>Refer to the MAC address table in the beginning of this guide. Documentation for more details can be found <a href="http://www.syslinux.org/wiki/index.php/PXELINUX">here</a>.</p>

<pre><code>cd /tftpboot/pxelinux.cfg
ln -s coreos-node-master 01-d0-00-67-13-0d-00
ln -s coreos-node-slave 01-d0-00-67-13-0d-01
ln -s coreos-node-slave 01-d0-00-67-13-0d-02
</code></pre>

<p>Reboot these servers to get the images PXEd and ready for running containers!</p>

<h2 id="creating-test-pod">Creating test pod</h2>

<p>Now that the CoreOS with Kubernetes installed is up and running lets spin up some Kubernetes pods to demonstrate the system.</p>

<p>See <a href="../../../docs/user-guide/simple-nginx.html">a simple nginx example</a> to try out your new cluster.</p>

<p>For more complete applications, please look in the <a href="../../../examples/">examples directory</a>.</p>

<h2 id="helping-commands-for-debugging">Helping commands for debugging</h2>

<p>List all keys in etcd:</p>

<pre><code> etcdctl ls --recursive
</code></pre>

<p>List fleet machines</p>

<pre><code>fleetctl list-machines
</code></pre>

<p>Check system status of services on master:</p>

<pre><code>systemctl status kube-apiserver
systemctl status kube-controller-manager
systemctl status kube-scheduler
systemctl status kube-register
</code></pre>

<p>Check system status of services on a node:</p>

<pre><code>systemctl status kube-kubelet
systemctl status docker.service
</code></pre>

<p>List Kubernetes</p>

<pre><code>kubectl get pods
kubectl get nodes
</code></pre>

<p>Kill all pods:</p>

<pre><code>for i in `kubectl get pods | awk '{print $1}'`; do kubectl stop pod $i; done
</code></pre>

	</div>
</section>


<footer>
	<main class="light-text">
		<nav>
			<a href="/getting-started.html">Getting Started</a>
			<a href="/docs.html">Documentation</a>
			<a href="http://blog.kubernetes.io/">Blog</a>
			<a href="/foobang.html">Community</a>
		</nav>
		<div class="social">
			<a href="https://twitter.com/kubernetesio" class="twitter"><span>twitter</span></a>
			<a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
			<a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
			<a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>stackoverflow</span></a>
			<a href="https://groups.google.com/forum/#!forum/google-containers" class="mailing-list"><span>Mailing List</span></a>
			<label for="wishField">I wish this page <input type="text" id="wishField" name="wishField" placeholder="made better textfield suggestions"></label>
		</div>
		<div class="center">&copy; 2016 Kubernetes</div>
	</main>
</footer>

</body>
</html>



