<!Doctype html>
<html id="docs">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href='https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="/css/styles.css"/>
	<script src="/js/script.js"></script>
    <script src="/js/jquery-2.2.0.min.js"></script>
    <script src="/js/non-mini.js"></script>
    <title>Kubernetes - Adding custom resources to the Kubernetes API server</title>
</head>
<body>
<div id="cellophane" onclick="kub.toggleMenu()"></div>
<header>
	<a href="/" class="logo"></a>
	<div class="nav-buttons" data-auto-burger="primary">
		<a href="/docs" class="button" id="viewDocs">View Documentation</a>
		<a href="/get-started" class="button" id="tryKubernetes">Try Kubernetes</a>
		<button id="hamburger" onclick="kub.toggleMenu()" data-auto-burger-exclude><div></div></button>
	</div>

	<nav id="mainNav">
		<main data-auto-burger="primary">
			<div class="nav-box">
				<h3><a href="">Get Started</a></h3>
				<p>Built for a multi-cloud world, public, private or hybrid. Seamlessly roll out new features.</p>
			</div>
			<div class="nav-box">
				<h3><a href="">Documentation</a></h3>
				<p>Pellentesque in ipsum id orci porta dapibus. Nulla porttitor accumsan tincidunt. </p>
			</div>
			<div class="nav-box">
				<h3><a href="">Community</a></h3>
				<p>Vestibulum ac diam sit amet quam vehicula elementum sed sit amet dui. </p>
			</div>
			<div class="nav-box">
				<h3><a href="">Blog</a></h3>
				<p>Curabitur arcu erat, accumsan id imperdiet et, porttitor at sem. Quisque velit nisi, pretium ut lacinia in. </p>
			</div>
		</main>
		<main data-auto-burger="primary">
			<div class="left">
				<h5 class="github-invite">Interested in hacking on the core Kubernetes code base?</h5>
				<a href="" class="button">View On Github</a>
			</div>

			<div class="right">
				<h5 class="github-invite">Explore the community</h5>
				<div class="social">
					<a href="https://twitter.com/kubernetesio" class="Twitter"><span>twitter</span></a>
					<a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
					<a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
					<a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>stackoverflow</span></a>
					<a href="https://groups.google.com/forum/#!forum/google-containers" class="mailing-list"><span>Mailing List</span></a>
				</div>
			</div>
			<div class="clear" style="clear: both"></div>
		</main>
	</nav>
</header>

<!--  HERO  -->
<section id="hero" class="light-text">
	<h1></h1>
	<h5></h5>
	<div id="vendorStrip" class="light-text">
		<ul>
			<li><a href="/v1.1/guides">GUIDES</a></li>
			<li><a href="/v1.1/reference">REFERENCE</a></li>
			<li><a href="/v1.1/samples">SAMPLES</a></li>
			<li><a href="/v1.1/support">SUPPORT</a></li>
		</ul>
		<div class="dropdown">
			<div class="readout"></div>
			<a href="/v1.1">Version 1.1</a>
			<a href="/v1.0">Version 1.0</a>
		</div>
		<input type="text" id="search" placeholder="Search the docs">
	</div>
</section>

<section id="encyclopedia">
	<div id="docsToc">
        <div class="pi-accordion">
            
            

        </div> <!-- /pi-accordion -->
	</div> <!-- /docsToc -->
	<div id="docsContent">
    	<h1>Adding custom resources to the Kubernetes API server</h1>
		<!-- BEGIN MUNGE: UNVERSIONED_WARNING -->

<!-- END MUNGE: UNVERSIONED_WARNING -->

<h1 id="adding-custom-resources-to-the-kubernetes-api-server">Adding custom resources to the Kubernetes API server</h1>

<p>This document describes the design for implementing the storage of custom API types in the Kubernetes API Server.</p>

<h2 id="resource-model">Resource Model</h2>

<h3 id="the-thirdpartyresource">The ThirdPartyResource</h3>

<p>The <code>ThirdPartyResource</code> resource describes the multiple versions of a custom resource that the user wants to add
to the Kubernetes API.  <code>ThirdPartyResource</code> is a non-namespaced resource, attempting to place it in a resource
will return an error.</p>

<p>Each <code>ThirdPartyResource</code> resource has the following:
   * Standard Kubernetes object metadata.
   * ResourceKind - The kind of the resources described by this third party resource.
   * Description - A free text description of the resource.
   * APIGroup - An API group that this resource should be placed into.
   * Versions - One or more <code>Version</code> objects.</p>

<h3 id="the-version-object">The <code>Version</code> Object</h3>

<p>The <code>Version</code> object describes a single concrete version of a custom resource.  The <code>Version</code> object currently
only specifies:
   * The <code>Name</code> of the version.
   * The <code>APIGroup</code> this version should belong to.</p>

<h2 id="expectations-about-third-party-objects">Expectations about third party objects</h2>

<p>Every object that is added to a third-party Kubernetes object store is expected to contain Kubernetes
compatible <a href="../devel/api-conventions.html#metadata">object metadata</a>.  This requirement enables the
Kubernetes API server to provide the following features:
   * Filtering lists of objects via LabelQueries
   * <code>resourceVersion</code>-based optimistic concurrency via compare-and-swap
   * Versioned storage
   * Event recording
   * Integration with basic <code>kubectl</code> command line tooling.
   * Watch for resource changes.</p>

<p>The <code>Kind</code> for an instance of a third-party object (e.g. CronTab) below is expected to be
programmatically convertible to the name of the resource using
the following conversion.  Kinds are expected to be of the form <code>&lt;CamelCaseKind&gt;</code>, the
<code>APIVersion</code> for the object is expected to be <code>&lt;domain-name&gt;/&lt;api-group&gt;/&lt;api-version&gt;</code>.</p>

<p>For example <code>example.com/stable/v1</code></p>

<p><code>domain-name</code> is expected to be a fully qualified domain name.</p>

<p>‘CamelCaseKind’ is the specific type name.</p>

<p>To convert this into the <code>metadata.name</code> for the <code>ThirdPartyResource</code> resource instance,
the <code>&lt;domain-name&gt;</code> is copied verbatim, the <code>CamelCaseKind</code> is
then converted
using ‘-‘ instead of capitalization (‘camel-case’), with the first character being assumed to be
capitalized.  In pseudo code:</p>

<div class="highlight">
  <pre><code class="language-go">var result string
for ix := range kindName {
  if isCapital(kindName[ix]) {
    result = append(result, '-')
  }
  result = append(result, toLowerCase(kindName[ix])
}
</code></pre>
</div>

<p>As a concrete example, the resource named <code>camel-case-kind.example.com</code> defines resources of Kind <code>CamelCaseKind</code>, in
the APIGroup with the prefix <code>example.com/...</code>.</p>

<p>The reason for this is to enable rapid lookup of a <code>ThirdPartyResource</code> object given the kind information.
This is also the reason why <code>ThirdPartyResource</code> is not namespaced.</p>

<h2 id="usage">Usage</h2>

<p>When a user creates a new <code>ThirdPartyResource</code>, the Kubernetes API Server reacts by creating a new, namespaced
RESTful resource path.  For now, non-namespaced objects are not supported. As with existing built-in objects
deleting a namespace, deletes all third party resources in that namespace.</p>

<p>For example, if a user creates:</p>

<div class="highlight">
  <pre><code class="language-yaml">metadata:
  name: cron-tab.example.com
apiVersion: extensions/v1beta1
kind: ThirdPartyResource
description: "A specification of a Pod to run on a cron style schedule"
versions:
  - name: stable/v1
  - name: experimental/v2
</code></pre>
</div>

<p>Then the API server will program in two new RESTful resource paths:
   * <code>/thirdparty/example.com/stable/v1/namespaces/&lt;namespace&gt;/crontabs/...</code>
   * <code>/thirdparty/example.com/experimental/v2/namespaces/&lt;namespace&gt;/crontabs/...</code></p>

<p>Now that this schema has been created, a user can <code>POST</code>:</p>

<div class="highlight">
  <pre><code class="language-json">{
   "metadata": {
     "name": "my-new-cron-object"
   },
   "apiVersion": "example.com/stable/v1",
   "kind": "CronTab",
   "cronSpec": "* * * * /5",
   "image":     "my-awesome-chron-image"
}
</code></pre>
</div>

<p>to: <code>/third-party/example.com/stable/v1/namespaces/default/crontabs/my-new-cron-object</code></p>

<p>and the corresponding data will be stored into etcd by the APIServer, so that when the user issues:</p>

<pre><code>
GET /third-party/example.com/stable/v1/namespaces/default/crontabs/my-new-cron-object`

</code></pre>

<p>And when they do that, they will get back the same data, but with additional Kubernetes metadata
(e.g. <code>resourceVersion</code>, <code>createdTimestamp</code>) filled in.</p>

<p>Likewise, to list all resources, a user can issue:</p>

<pre><code>
GET /third-party/example.com/stable/v1/namespaces/default/crontabs

</code></pre>

<p>and get back:</p>

<div class="highlight">
  <pre><code class="language-json">{
   "apiVersion": "example.com/stable/v1",
   "kind": "CronTabList",
   "items": [
     {
       "metadata": {
         "name": "my-new-cron-object"
       },
       "apiVersion": "example.com/stable/v1",
       "kind": "CronTab",
       "cronSpec": "* * * * /5",
       "image":     "my-awesome-chron-image"
    }
   ]
}
</code></pre>
</div>

<p>Because all objects are expected to contain standard Kubernetes metadata fields, these
list operations can also use <code>Label</code> queries to filter requests down to specific subsets.</p>

<p>Likewise, clients can use watch endpoints to watch for changes to stored objects.</p>

<h2 id="storage">Storage</h2>

<p>In order to store custom user data in a versioned fashion inside of etcd, we need to also introduce a
<code>Codec</code>-compatible object for persistent storage in etcd.  This object is <code>ThirdPartyResourceData</code> and it contains:
   * Standard API Metadata
   * <code>Data</code>: The raw JSON data for this custom object.</p>

<h3 id="storage-key-specification">Storage key specification</h3>

<p>Each custom object stored by the API server needs a custom key in storage, this is described below:</p>

<h4 id="definitions">Definitions</h4>

<ul>
  <li><code>resource-namespace</code> : the namespace of the particular resource that is being stored</li>
  <li><code>resource-name</code>: the name of the particular resource being stored</li>
  <li><code>third-party-resource-namespace</code>: the namespace of the <code>ThirdPartyResource</code> resource that represents the type for the specific instance being stored.</li>
  <li><code>third-party-resource-name</code>: the name of the <code>ThirdPartyResource</code> resource that represents the type for the specific instance being stored.</li>
</ul>

<h4 id="key">Key</h4>

<p>Given the definitions above, the key for a specific third-party object is:</p>

<pre><code>
${standard-k8s-prefix}/third-party-resources/${third-party-resource-namespace}/${third-party-resource-name}/${resource-namespace}/${resource-name}

</code></pre>

<p>Thus, listing a third-party resource can be achieved by listing the directory:</p>

<pre><code>
${standard-k8s-prefix}/third-party-resources/${third-party-resource-namespace}/${third-party-resource-name}/${resource-namespace}/

</code></pre>

<!-- BEGIN MUNGE: IS_VERSIONED -->
<!-- TAG IS_VERSIONED -->
<!-- END MUNGE: IS_VERSIONED -->

<!-- BEGIN MUNGE: GENERATED_ANALYTICS -->
<p><a href=""><img src="https://kubernetes-site.appspot.com/UA-36037335-10/GitHub/docs/design/extending-api.md?pixel" alt="Analytics" /></a>
<!-- END MUNGE: GENERATED_ANALYTICS --></p>


	</div>
</section>


<footer>
	<main class="light-text">
		<nav>
			<a href="/getting-started.html">Getting Started</a>
			<a href="/docs.html">Documentation</a>
			<a href="http://blog.kubernetes.io/">Blog</a>
			<a href="/foobang.html">Community</a>
		</nav>
		<div class="social">
			<a href="https://twitter.com/kubernetesio" class="twitter"><span>twitter</span></a>
			<a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
			<a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
			<a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>stackoverflow</span></a>
			<a href="https://groups.google.com/forum/#!forum/google-containers" class="mailing-list"><span>Mailing List</span></a>
			<label for="wishField">I wish this page <input type="text" id="wishField" name="wishField" placeholder="made better textfield suggestions"></label>
		</div>
		<div class="center">&copy; 2016 Kubernetes</div>
	</main>
</footer>

</body>
</html>



