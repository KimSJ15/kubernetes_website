<!Doctype html>
<html id="docs">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href='https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="/css/styles.css"/>
	<script src="/js/script.js"></script>
    <script src="/js/jquery-2.2.0.min.js"></script>
    <script src="/js/non-mini.js"></script>
    <title>Kubernetes - Simple rolling update</title>
</head>
<body>
<div id="cellophane" onclick="kub.toggleMenu()"></div>
<header>
	<a href="/" class="logo"></a>
	<div class="nav-buttons" data-auto-burger="primary">
		<a href="/docs" class="button" id="viewDocs">View Documentation</a>
		<a href="/get-started" class="button" id="tryKubernetes">Try Kubernetes</a>
		<button id="hamburger" onclick="kub.toggleMenu()" data-auto-burger-exclude><div></div></button>
	</div>

	<nav id="mainNav">
		<main data-auto-burger="primary">
			<div class="nav-box">
				<h3><a href="">Get Started</a></h3>
				<p>Built for a multi-cloud world, public, private or hybrid. Seamlessly roll out new features.</p>
			</div>
			<div class="nav-box">
				<h3><a href="">Documentation</a></h3>
				<p>Pellentesque in ipsum id orci porta dapibus. Nulla porttitor accumsan tincidunt. </p>
			</div>
			<div class="nav-box">
				<h3><a href="">Community</a></h3>
				<p>Vestibulum ac diam sit amet quam vehicula elementum sed sit amet dui. </p>
			</div>
			<div class="nav-box">
				<h3><a href="">Blog</a></h3>
				<p>Curabitur arcu erat, accumsan id imperdiet et, porttitor at sem. Quisque velit nisi, pretium ut lacinia in. </p>
			</div>
		</main>
		<main data-auto-burger="primary">
			<div class="left">
				<h5 class="github-invite">Interested in hacking on the core Kubernetes code base?</h5>
				<a href="" class="button">View On Github</a>
			</div>

			<div class="right">
				<h5 class="github-invite">Explore the community</h5>
				<div class="social">
					<a href="https://twitter.com/kubernetesio" class="Twitter"><span>twitter</span></a>
					<a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
					<a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
					<a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>stackoverflow</span></a>
					<a href="https://groups.google.com/forum/#!forum/google-containers" class="mailing-list"><span>Mailing List</span></a>
				</div>
			</div>
			<div class="clear" style="clear: both"></div>
		</main>
	</nav>
</header>

<!--  HERO  -->
<section id="hero" class="light-text">
	<h1></h1>
	<h5></h5>
	<div id="vendorStrip" class="light-text">
		<ul>
			<li><a href="/v1.1/">GUIDES</a></li>
			<li><a href="/v1.1/reference">REFERENCE</a></li>
			<li><a href="/v1.1/samples">SAMPLES</a></li>
			<li><a href="/v1.1/support">SUPPORT</a></li>
		</ul>
		<div class="dropdown">
			<div class="readout"></div>
			<a href="/v1.1">Version 1.1</a>
			<a href="/v1.0">Version 1.0</a>
		</div>
		<input type="text" id="search" placeholder="Search the docs">
	</div>
</section>

<section id="encyclopedia">
	<div id="docsToc">
        <div class="pi-accordion">
            
            

        </div> <!-- /pi-accordion -->
	</div> <!-- /docsToc -->
	<div id="docsContent">
    	<h1>Simple rolling update</h1>
		<!-- BEGIN MUNGE: UNVERSIONED_WARNING -->

<!-- END MUNGE: UNVERSIONED_WARNING -->

<h2 id="simple-rolling-update">Simple rolling update</h2>

<p>This is a lightweight design document for simple <a href="../user-guide/kubectl/kubectl_rolling-update.html">rolling update</a> in <code>kubectl</code>.</p>

<p>Complete execution flow can be found <a href="#execution-details">here</a>. See the <a href="../user-guide/update-demo/">example of rolling update</a> for more information.</p>

<h3 id="lightweight-rollout">Lightweight rollout</h3>

<p>Assume that we have a current replication controller named <code>foo</code> and it is running image <code>image:v1</code></p>

<p><code>kubectl rolling-update foo [foo-v2] --image=myimage:v2</code></p>

<p>If the user doesn’t specify a name for the ‘next’ replication controller, then the ‘next’ replication controller is renamed to
the name of the original replication controller.</p>

<p>Obviously there is a race here, where if you kill the client between delete foo, and creating the new version of ‘foo’ you might be surprised about what is there, but I think that’s ok.
See <a href="#recovery">Recovery</a> below</p>

<p>If the user does specify a name for the ‘next’ replication controller, then the ‘next’ replication controller is retained with its existing name,
and the old ‘foo’ replication controller is deleted.  For the purposes of the rollout, we add a unique-ifying label <code>kubernetes.io/deployment</code> to both the <code>foo</code> and <code>foo-next</code> replication controllers.
The value of that label is the hash of the complete JSON representation of the<code>foo-next</code> or<code>foo</code> replication controller.  The name of this label can be overridden by the user with the <code>--deployment-label-key</code> flag.</p>

<h4 id="recovery">Recovery</h4>

<p>If a rollout fails or is terminated in the middle, it is important that the user be able to resume the roll out.
To facilitate recovery in the case of a crash of the updating process itself, we add the following annotations to each replication controller in the <code>kubernetes.io/</code> annotation namespace:
   * <code>desired-replicas</code> The desired number of replicas for this replication controller (either N or zero)
   * <code>update-partner</code> A pointer to the replication controller resource that is the other half of this update (syntax <code>&lt;name&gt;</code> the namespace is assumed to be identical to the namespace of this replication controller.)</p>

<p>Recovery is achieved by issuing the same command again:</p>

<div class="highlight">
  <pre><code class="language-sh">kubectl rolling-update foo [foo-v2] --image=myimage:v2
</code></pre>
</div>

<p>Whenever the rolling update command executes, the kubectl client looks for replication controllers called <code>foo</code> and <code>foo-next</code>, if they exist, an attempt is
made to roll <code>foo</code> to <code>foo-next</code>.  If <code>foo-next</code> does not exist, then it is created, and the rollout is a new rollout.  If <code>foo</code> doesn’t exist, then
it is assumed that the rollout is nearly completed, and <code>foo-next</code> is renamed to <code>foo</code>.  Details of the execution flow are given below.</p>

<h3 id="aborting-a-rollout">Aborting a rollout</h3>

<p>Abort is assumed to want to reverse a rollout in progress.</p>

<p><code>kubectl rolling-update foo [foo-v2] --rollback</code></p>

<p>This is really just semantic sugar for:</p>

<p><code>kubectl rolling-update foo-v2 foo</code></p>

<p>With the added detail that it moves the <code>desired-replicas</code> annotation from <code>foo-v2</code> to <code>foo</code></p>

<h3 id="execution-details">Execution Details</h3>

<p>For the purposes of this example, assume that we are rolling from <code>foo</code> to <code>foo-next</code> where the only change is an image update from <code>v1</code> to <code>v2</code></p>

<p>If the user doesn’t specify a <code>foo-next</code> name, then it is either discovered from the <code>update-partner</code> annotation on <code>foo</code>.  If that annotation doesn’t exist,
then <code>foo-next</code> is synthesized using the pattern <code>&lt;controller-name&gt;-&lt;hash-of-next-controller-JSON&gt;</code></p>

<h4 id="initialization">Initialization</h4>

<ul>
  <li>If <code>foo</code> and <code>foo-next</code> do not exist:
    <ul>
      <li>Exit, and indicate an error to the user, that the specified controller doesn’t exist.</li>
    </ul>
  </li>
  <li>If <code>foo</code> exists, but <code>foo-next</code> does not:
    <ul>
      <li>Create <code>foo-next</code> populate it with the <code>v2</code> image, set <code>desired-replicas</code> to <code>foo.Spec.Replicas</code></li>
      <li>Goto Rollout</li>
    </ul>
  </li>
  <li>If <code>foo-next</code> exists, but <code>foo</code> does not:
    <ul>
      <li>Assume that we are in the rename phase.</li>
      <li>Goto Rename</li>
    </ul>
  </li>
  <li>If both <code>foo</code> and <code>foo-next</code> exist:
    <ul>
      <li>Assume that we are in a partial rollout</li>
      <li>If <code>foo-next</code> is missing the <code>desired-replicas</code> annotation
        <ul>
          <li>Populate the <code>desired-replicas</code> annotation to <code>foo-next</code> using the current size of <code>foo</code></li>
        </ul>
      </li>
      <li>Goto Rollout</li>
    </ul>
  </li>
</ul>

<h4 id="rollout">Rollout</h4>

<ul>
  <li>While size of <code>foo-next</code> &lt; <code>desired-replicas</code> annotation on <code>foo-next</code>
    <ul>
      <li>increase size of <code>foo-next</code></li>
      <li>if size of <code>foo</code> &gt; 0
 decrease size of <code>foo</code></li>
    </ul>
  </li>
  <li>Goto Rename</li>
</ul>

<h4 id="rename">Rename</h4>

<ul>
  <li>delete <code>foo</code></li>
  <li>create <code>foo</code> that is identical to <code>foo-next</code></li>
  <li>delete <code>foo-next</code></li>
</ul>

<h4 id="abort">Abort</h4>

<ul>
  <li>If <code>foo-next</code> doesn’t exist
    <ul>
      <li>Exit and indicate to the user that they may want to simply do a new rollout with the old version</li>
    </ul>
  </li>
  <li>If <code>foo</code> doesn’t exist
    <ul>
      <li>Exit and indicate not found to the user</li>
    </ul>
  </li>
  <li>Otherwise, <code>foo-next</code> and <code>foo</code> both exist
    <ul>
      <li>Set <code>desired-replicas</code> annotation on <code>foo</code> to match the annotation on <code>foo-next</code></li>
      <li>Goto Rollout with <code>foo</code> and <code>foo-next</code> trading places.</li>
    </ul>
  </li>
</ul>

<!-- BEGIN MUNGE: IS_VERSIONED -->
<!-- TAG IS_VERSIONED -->
<!-- END MUNGE: IS_VERSIONED -->

<!-- BEGIN MUNGE: GENERATED_ANALYTICS -->
<p><a href=""><img src="https://kubernetes-site.appspot.com/UA-36037335-10/GitHub/docs/design/simple-rolling-update.md?pixel" alt="Analytics" /></a>
<!-- END MUNGE: GENERATED_ANALYTICS --></p>


	</div>
</section>


<footer>
	<main class="light-text">
		<nav>
			<a href="/getting-started.html">Getting Started</a>
			<a href="/docs.html">Documentation</a>
			<a href="http://blog.kubernetes.io/">Blog</a>
			<a href="/foobang.html">Community</a>
		</nav>
		<div class="social">
			<a href="https://twitter.com/kubernetesio" class="twitter"><span>twitter</span></a>
			<a href="https://github.com/kubernetes/kubernetes" class="github"><span>Github</span></a>
			<a href="http://slack.k8s.io/" class="slack"><span>Slack</span></a>
			<a href="http://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>stackoverflow</span></a>
			<a href="https://groups.google.com/forum/#!forum/google-containers" class="mailing-list"><span>Mailing List</span></a>
			<label for="wishField">I wish this page <input type="text" id="wishField" name="wishField" placeholder="made better textfield suggestions"></label>
		</div>
		<div class="center">&copy; 2016 Kubernetes</div>
	</main>
</footer>

</body>
</html>



